var accountModule = angular.module("AccountModule", ["ResourceModule", "HttpModule"]);
accountModule.service("AccountService", ["ResourceService", "ManagementHttpService", "ResourceFactory", function (d, c, b) {
    var a = {};
    a.initialize = function () {
    };
    a.getPatientInfo = function (e) {
        var f = e.requestData;
        c.wePatientRequest(f, b.operateCode.get, function (g) {
            if (g.Header.StatusCode == 0) {
                b.saveDataToSession("CurrentPatient", g.Body);
                e.currentPatient = g.Body;
                a.searchAccounts(e)
            } else {
                alert(b.getErrorMsg(g.Header.StatusCode))
            }
        }, function (g) {
            console.log(g)
        })
    };
    a.searchAccounts = function (f) {
        var g = {PatientID: f.currentPatient.PatientID};
        try {
            c.WeGetBillsByPatientRequest(g, b.operateCode.get, function (e) {
                if (e.Header.StatusCode == 0) {
                    f.accountList = e.Body;
                    $(".page__bd").css("display", "block");
                } else {
                    alert(b.getErrorMsg(e.Header.StatusCode))
                }
            }, function (e) {
                alert("系统繁忙，请稍候重试！");
                console.log(e)
            })
        } catch (h) {
            console.log(h)
        }
    };
    a.goToWaitPay = function (item) {
        b.saveDataToSession("CurrentAccount", item);
        window.location.href = "WaitPay.html";
    };
    a.goToDetail = function (item) {
        b.saveDataToSession("CurrentAccount", item);
        window.location.href = "AccountDetail.html";
    };
    return a
}]);
accountModule.controller("AccountController", ["$scope", "AccountService", "ResourceService", "ResourceFactory", function (a, b, c, ResourceFactory) {
    a.initialize = function () {
        a.requestData = {Code: c.getURLData("code")};
        b.initialize();

        a.currentPatient = ResourceFactory.getDataFromSession("CurrentPatient");
        if (!a.currentPatient) {
            b.getPatientInfo(a);
        }
        else {
            b.searchAccounts(a);
        }
    };

    a.goToWaitPay = function (item) {
        b.goToWaitPay(item);
    };

    a.goToDetail = function (item) {
        b.goToDetail(item);
    };

    a.statusText = function (status) {
        if (status == 0 || status == 1) {
            return "待支付";
        } else if (status == 4) {
            return "已支付";
        } else if (status == 2) {
            return "欠费";
        } else if (status == 3) {
            return "已完成";
        } else if (status == 5) {
            return "申退中";
        } else {
            return "未知";
        }
    };

    a.showName = function (cost) {
        if (!cost) {
            return "";
        }

        if (cost.CostItem) {
            return cost.CostItem;
        }

        if (cost.SubCategoryName) {
            return cost.SubCategoryName;
        }

        if (cost.CategoryName) {
            return cost.CategoryName;
        }

        return "";
    };

    a.initialize();
}]);
angular.bootstrap($("#account_list"), ["AccountModule"]);