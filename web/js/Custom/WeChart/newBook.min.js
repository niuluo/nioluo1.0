var newBookModule=angular.module("NewBookModule",["ResourceModule","HttpModule"]);newBookModule.service("NewBookService",["ManagementHttpService","ResourceService","ResourceFactory",function(d,e,b){var a={};var c={};a.initialize=function(f){e.bindingDateControl("appoint_begin_date",true,new Date());e.bindingDateControl("appoint_end_date",true,new Date());c=f};a.initAppointItems=function(){$("#appoint_item_list").mobiscroll().treelist({theme:"android-ics light",lang:"zh",display:"bottom",defaultValue:[1,1,1],fixedWidth:[120,120,120],btnClass:"",labels:["科室","类别","预约项目"],showLabel:true,headerText:function(f){return"请选择预约事项"},rows:5,onSelect:function(f,g){a.callback(f)},formatResult:function(i){var g=$("#appoint_item_list>li").eq(i[0]).find("ul.second_item").eq(i[1]).find("ul li").eq(i[2]).attr("data-bind");var f=$("#appoint_item_list>li").eq(i[0]).find("ul.second_item").eq(i[1]).find("span").attr("data-bind");var h=$("#appoint_item_list>li").eq(i[0]).children("span").attr("data-bind");return h+"_"+f+"_"+g}})};a.getPatientInfo=function(f){var g=f.requestData;d.wePatientRequest(g,b.operateCode.get,function(h){if(h.Header.StatusCode==0){b.saveDataToSession("CurrentPatient",h.Body);f.currentPatient=h.Body;f.newAppoint={ID:0,AppointID:"",PatientID:f.currentPatient.PatientID,PatientName:f.currentPatient.Name,Birthday:f.currentPatient.Birthday,Gender:f.currentPatient.Gender,Mobile:f.currentPatient.Mobile,Address:f.currentPatient.Address,OtherContact:f.currentPatient.OtherContact,BeginTime:"",EndTime:"",AppointDetail:"",Status:1,DoctorID:"",DoctorName:"",AppointType:"",PatientSourceID:f.currentPatient.PatientSourceID,PatientLevelID:f.currentPatient.PatientLevelID,Remark:"",AppointItemID:"",AppointItemName:"",SubCategoryID:"",SubCategoryName:"",CategoryID:"",CategoryName:"",State:0,CreateTime:"",TenantID:f.currentPatient.TenantID};a.getDoctorsAndItems(f)}else{alert(b.getErrorMsg(h.Header.StatusCode))}},function(h){console.log(h)})};a.getDoctorsAndItems=function(f){var g={TenantID:f.currentPatient.TenantID};try{d.weAppointInfoRequest(g,b.operateCode.get,function(i){if(i.Header.StatusCode==0){f.appointItems=i.Body.AppointItems;f.doctors=i.Body.Doctors}else{alert(e.getErrorMsg(i.Header.StatusCode));console.log(i)}},function(i){console.log(i)})}catch(h){console.log(h)}};a.saveAppoint=function(f){var g=f.newAppoint;try{d.weAppointRequest(g,b.operateCode.insert,function(i){if(i.Header.StatusCode==0){alert("预约成功！");f.newAppoint=i.Body;f.isReadonly=true}else{alert(e.getErrorMsg(i.Header.StatusCode));console.log(i)}},function(i){console.log(i)})}catch(h){console.log(h)}};a.callback=function(j){if(j){var f=j.split("_");var i=$.parseJSON(f[0]);var h=$.parseJSON(f[1]);var g=$.parseJSON(f[2]);c.newAppoint.CategoryID=i.CategoryID;c.newAppoint.CategoryName=i.Name;c.newAppoint.SubCategoryID=h.SubCategoryID;c.newAppoint.SubCategoryName=h.Name;c.newAppoint.AppointItemID=g.AppointItemID;c.newAppoint.AppointItemName=g.Name;c.$apply()}};return a}]);newBookModule.controller("NewBookController",["$scope","NewBookService","ResourceService","ResourceFactory",function(b,c,d,a){b.initialize=function(){b.requestData={Code:d.getURLData("code")};b.appointTypeList=[{Type:1,Name:"初诊"},{Type:2,Name:"复诊"}];b.isReadonly=false;b.selectedDoctor={};b.currentPatient=a.getDataFromSession("CurrentPatient");c.initialize(b);if(!b.currentPatient){c.getPatientInfo(b)}else{c.getDoctorsAndItems(b)}};b.addNewAppoint=function(){b.newAppoint.DoctorID=b.selectedDoctor.UserID;b.newAppoint.DoctorName=b.selectedDoctor.UserName;if(!b.selectedDoctor.UserID||!b.newAppoint.AppointItemID||!b.newAppoint.BeginTime||!b.newAppoint.EndTime||!b.newAppoint.AppointType){alert("对不起，预约信息有误，请检查是否遗漏信息！");return}if(b.newAppoint.BeginTime>=b.newAppoint.EndTime){alert("对不起，您输入预约的开始时间不能大于或等于截止时间！");return}c.saveAppoint(b)};b.showItems=function(){c.initAppointItems();$("#appoint_item_list_dummy").css({display:"none"});$("#appoint_item_list_dummy").click()};b.getAppointTypeName=function(e){switch(e){case 1:return"初诊";case 2:return"复诊";default:return""}};b.addNewOtherAppoint=function(){b.isReadonly=false;b.newAppoint={ID:0,AppointID:"",PatientID:b.currentPatient.PatientID,PatientName:b.currentPatient.Name,Birthday:b.currentPatient.Birthday,Gender:b.currentPatient.Gender,Mobile:b.currentPatient.Mobile,Address:b.currentPatient.Address,OtherContact:b.currentPatient.OtherContact,BeginTime:"",EndTime:"",AppointDetail:"",Status:1,DoctorID:"",DoctorName:"",AppointType:"",PatientSourceID:b.currentPatient.PatientSourceID,PatientLevelID:b.currentPatient.PatientLevelID,Remark:"",AppointItemID:"",AppointItemName:"",SubCategoryID:"",SubCategoryName:"",CategoryID:"",CategoryName:"",State:0,CreateTime:"",TenantID:b.currentPatient.TenantID}};b.initialize()}]);angular.bootstrap($("#new_appoint"),["NewBookModule"]);