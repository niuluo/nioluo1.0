var payModule = angular.module("PayModule", ["ResourceModule", "HttpModule"]);

payModule.service("PayService", ["ResourceFactory", "ManagementHttpService", function (ResourceFactory, ManagementHttpService) {
    var service = {};

    //初始化环境
    service.initialize = function ($scope) {
        $scope.InstallmentTimes = "1";
        $scope.currentPatient = ResourceFactory.getDataFromSession("CurrentPatient");
        $scope.currentAccount = ResourceFactory.getDataFromSession("CurrentAccount");
    };

    // 支付
    service.pay = function (f) {
        var g = {
            BillNo: f.currentAccount.BillNo,
            Pay: {
                PaymentType: 4
            },
            Type: 88,
            Subject: "工行支付",
            ReturnUrl: "",
            ShowUrl: "",
            InstallmentTimes: f.InstallmentTimes
        };
        try {
            ManagementHttpService.WePaymentRequest(g, ResourceFactory.operateCode.insert, function (e) {
                if (e.Header.StatusCode == 0) {
                    $("body").append(e.Body.Content);
                } else {
                    alert(ResourceFactory.getErrorMsg(e.Header.StatusCode))
                }
            }, function (e) {
                alert("系统繁忙，请稍候重试！");
                console.log(e);
            })
        } catch (h) {
            console.log(h)
        }
    };

    return service;
}]);

payModule.controller("PayController", ["$scope", "PayService", function ($scope, PayService) {
    //初始化环境
    $scope.initialize = function () {
        PayService.initialize($scope);
    };

    // todo
    $scope.pay = function () {
        PayService.pay($scope);
    };

    $scope.initialize();
}]);

angular.bootstrap($("#pay"), ["PayModule"]);