var refundModule = angular.module("RefundModule", ["ResourceModule", "HttpModule"]);

refundModule.service("RefundService", ["ResourceFactory", "ManagementHttpService", function (ResourceFactory, ManagementHttpService) {
    var service = {};

    //初始化环境
    service.initialize = function ($scope) {
        $scope.currentPatient = ResourceFactory.getDataFromSession("CurrentPatient");
        $scope.currentAccount = ResourceFactory.getDataFromSession("CurrentAccount");
    };

    // 退费
    service.refund = function ($scope) {
        if(!$scope.RefundReason) {
            alert("请填写问题描述");
            return;
        }

        if($scope.RefundReason.length > 100) {
            alert("问题描述最多100字");
            return;
        }

        var g = {
            BillNo: $scope.currentAccount.BillNo,
            RefundReason: $scope.RefundReason
        };
        try {
            ManagementHttpService.WeApplyRefundRequest(g, ResourceFactory.operateCode.insert, function (e) {
                if (e.Header.StatusCode == 0) {
                    alert("申退成功");
                    window.location.href = "DCAccount.html";
                } else {
                    alert(ResourceFactory.getErrorMsg(e.Header.StatusCode))
                }
            }, function (e) {
                alert("系统繁忙，请稍候重试！");
                console.log(e);
            })
        } catch (h) {
            console.log(h)
        }
    };

    return service;
}]);

refundModule.controller("RefundController", ["$scope", "RefundService", function ($scope, RefundService) {
    //初始化环境
    $scope.initialize = function () {
        RefundService.initialize($scope);
    };

    $scope.refund = function () {
        RefundService.refund($scope);
    };

    $scope.initialize();
}]);

angular.bootstrap($("#refund"), ["RefundModule"]);