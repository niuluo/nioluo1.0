var BookMG={init:function(){$("#loading_div").modal("show");MenuActive.setActive(MenuEnum.BookMG);CommonFun.bindingDateControl("workday","",new Date(),false);CommonFun.bindingDateControl("workdayBegin","",new Date(),true,"hour");CommonFun.bindingDateControl("workdayEnd","",new Date(),true,"hour");CommonFun.bindingDateControl("birthday",new Date(),"",false);$.formValidator.initConfig({validatorGroup:"1",mode:"AlertTip"});$($("#new_appoint input[name='name']")[0]).formValidator({validatorGroup:"1"}).functionValidator({fun:BookMG.validateRequired});$($("#new_appoint input[name='mobile']")[0]).formValidator({validatorGroup:"1"}).functionValidator({fun:BookMG.validateMobile});$($("#new_appoint input[name='workTime']")[0]).formValidator({validatorGroup:"1"}).functionValidator({fun:BookMG.validateDate})},validateRequired:function(b,a){if(!CommonFun.checkFormat(b,DataTypeEnum.Required)){return"此项为必填项"}else{return true}},validateMobile:function(b,a){if(!CommonFun.checkFormat(b,DataTypeEnum.Contract)&&!CommonFun.checkFormat(b,DataTypeEnum.PhoneMobile)){return"电话号码无效，请重新输入"}else{return true}},validateDate:function(b,a){if(!CommonFun.checkFormat(b,DataTypeEnum.DateFormat)){return"日期格式不对，请重新输入！"}else{return true}}};BookMG.init();var bookModule=angular.module("BookModule",["HttpModule","CalendarModule","PermissionModule"]);bookModule.service("BookService",["HttpService","ResourceFactory","PermissionFactory","$compile","CalendarService",function(d,e,h,f,a){var k={};var j=null;var b=function(m,p,n){if(p&&p.length>0){var o=p.length*100;$("#doctor_list").css("width",o);m.maxlength=o;$($("#doctor_list_area").find("button.ui-corner-right")[0]).addClass("cus_span_icon_disabled");if(o<=n){$($("#doctor_list_area").find("button.ui-corner-left")[0]).addClass("cus_span_icon_disabled")}else{$($("#doctor_list_area").find("button.ui-corner-left")[0]).addClass("cus_span_icon_active")}}};var i=function(n){var m=0;var p=CommonFun.getDataFromSession("CurrentAppoint");if(p){for(var o=0;o<n.appointmentList.DoctorAppoints.length;o++){if(n.appointmentList.DoctorAppoints[o].Doctor.UserID==p.Appoint.DoctorID){m=o;n.showCurrentAppoint(p);CommonFun.deleteDataFromSession("CurrentAppoint");break}}}return m};var c=function(m){switch(m){case 1:case 5:return true;case 2:return true;case 3:case 4:return false;default:return false}};var l=function(m){if(j){j.newAppoint.PatientName=m.Name;j.newAppoint.Age=m.Birthday?CommonFun.calculateAge(new Date(m.Birthday).Format("yyyy-MM-dd")):"";j.newAppoint.PatientID=m.PatientID;j.newAppoint.Birthday=m.Birthday;j.newAppoint.Gender=m.Gender;j.newAppoint.Mobile=m.Mobile;j.newAppoint.Address=m.Address;j.newAppoint.OtherContact=m.OtherContact;j.newAppoint.PatientSourceID=m.PatientSourceID;j.disablePatientEdit=true;j.$apply()}};var g=function(){j.newAppoint.PatientID="";j.newAppoint.Birthday="";j.newAppoint.Gender=1;j.newAppoint.Mobile="";j.newAppoint.Address="";j.newAppoint.OtherContact="";j.newAppoint.PatientSourceID="";j.disablePatientEdit=false;j.$apply()};k.getAppointColor=function(m){switch(m){case 1:return"#468847";case 2:return"#3a87fd";case 3:return"#c09853";case 4:return"#8B8682";case 5:return"#b94a48";default:return""}};k.GetAppointment=function(m){j=m;m.currentTenant=CommonFun.getDataFromSession("CurrentUser").Body.Tenant;var n={IsGroup:1,TenantID:CommonFun.getDataFromSession("CurrentUser").Body.Tenant.TenantID,IsNeedPatient:true,IsNeedDoctor:true};try{d.appointmentRequest(n,e.operateCode.get,function(q){$("#loading_div").modal("hide");$(".body_hide").css("opacity","1");if(q.Header.StatusCode==0){m.appointmentList=q.Body;m.patientList=q.Body.PatientList;m.doctorList=q.Body.DoctorList;m.patientSourceList=q.Body.PatientSourceList;m.patientLevelList=q.Body.PatientLevelList;var p=i(m);m.currentIndex=p;m.callBack(m.currentViewName);k.changeDoctor(m,p);b(m,m.appointmentList.DoctorList,m.doctorShowWidth);if(m.patientList){var r=[];angular.forEach(m.patientList,function(t,s){r.push({label:t.Name,value:JSON.stringify(t)})});$("#app_p_name").autocomplete({minLength:1,delay:0,source:r,focus:function(s,t){return false},select:function(t,u){var s=JSON.parse(u.item.value);l(s);return false},change:function(s,t){if(!t.item){g()}},search:function(s,t){},response:function(s,t){if(!t.content||t.content.length==0){g()}}})}if($("#workday1").length<=0){m.calendarDate=new Date().Format("yyyy-MM-dd");setTimeout(function(){var s=f('<div class="date"><input id="workday1" type="text" class="form-control" placeholder="预约时间" ng-model="calendarDate"></div>')(m);angular.element($($($("#book-calendar div.fc-left").children("div.fc-button-group")[1]).find("button.ui-corner-right")[0])).before(s);$("#book-calendar div.fc-toolbar").css("margin-bottom","1%");CommonFun.bindingDateControl("workday1","","",false)},500)}}else{k.alert("信息获取失败！");m.callBack(m.currentViewName);m.appointmentList=null;m.patientList=null;m.doctorList=null}},function(p){k.alert("系统繁忙，请稍候再试！");console.log(p)})}catch(o){console.log(o)}};k.getAppointmentItemsList=function(m){var n={TenantID:CommonFun.getDataFromSession("CurrentUser").Body.Tenant.TenantID};d.appointmentItemsRequest(n,e.operateCode.get,function(o){if(o.Header.StatusCode==0){m.appointmentItems=o.Body}else{m.appointmentItems=null}},function(o){console.log(o)})};k.changeDoctor=function(o,r){o.events=[];a.uiConfig.calendar.eventSources=[];var s=10000;if(o.appointmentList!=null&&o.appointmentList.DoctorAppoints.length>0){var m=o.appointmentList.DoctorAppoints[r];o.currentDoctorAppoints=o.appointmentList.DoctorAppoints[r].Dates;for(var p=0;p<m.Dates.length;p++){for(var n=0;n<m.Dates[p].AppointList.length;n++){var q={id:s++,title:m.Dates[p].AppointList[n].Appoint.PatientName+"\n"+m.Dates[p].AppointList[n].Appoint.AppointItemName+"\n"+m.Dates[p].AppointList[n].Appoint.Mobile,start:new Date(m.Dates[p].AppointList[n].Appoint.BeginTime),end:new Date(m.Dates[p].AppointList[n].Appoint.EndTime),color:k.getAppointColor(m.Dates[p].AppointList[n].Appoint.Status),editable:c(m.Dates[p].AppointList[n].Appoint.Status),source:m.Dates[p].AppointList[n]};o.events.push(q)}}a.uiConfig.calendar.eventSources[0]=o.events}};k.saveAppoint=function(o,m){var n=o;try{d.appointmentRequest(n,e.operateCode.insert,function(q){if(q.Header.StatusCode==0){o=q.Body;k.GetAppointment(m);$("#new_appoint").modal("hide");k.alert("预约成功");m.isAddNewAppoint=false}else{if(q.Header.StatusCode==18){var r=q.Body.Gender==2?"女":"男";k.confirm("对不起，该手机号已经注册，手机号主人姓名：【"+q.Body.Name+"】，性别：【"+r+"】，是否关联该手机号？",function(){m.isRelation=true;m.newAppoint.Relation=1;m.newAppoint.MainID=q.Body.PatientID;m.$apply()})}else{k.alert(GetErrormsg(q.Header.StatusCode))}}},function(q){k.alert(GetErrormsg(q.Header.StatusCode));console.log(q)})}catch(p){console.log(p)}};k.updateAppointments=function(p,m,n,o){d.appointmentRequest(p,e.operateCode.update,function(q){$("#loading_div").modal("hide");if(q.Header.StatusCode==0){m.currentIndex=0;if(o){k.alert("取消成功！");m.currentAppoint={};k.GetAppointment(m);m.refreshShowEdit(0)}else{k.alert("更新成功！");k.GetAppointment(m);m.refreshShowEdit(0)}}else{if(q.Header.StatusCode==18){k.alert("对不起，该手机号已经存在，手机号主人姓名：【"+q.Body.Name+"】，如果选择更新，请到患者管理强制更新");return}if(q.Header.StatusCode==34){k.alert("当前手机号有关联的信息，如果选择更新，所有关联的信息的手机号会一起更新，请到患者管理强制更新");return}if(q.Header.StatusCode==35){k.alert("对不起，您的手机号目前被其他患者关联，您无法关联其他手机号！");return}k.alert(GetErrormsg(q.Header.StatusCode))}},function(q){console.log(q)})};k.showCurrentPatient=function(p,r,o){var q=p.target;var m=$(q).offset().top;var s=$(q).offset().left+60;var n='<div class="tempPatientDetail" style="background: #fff; -webkit-border-radius: 4px; -moz-border-radius: 4px;border-radius: 4px;box-shadow: 0 0 3px #999;">性别: '+(r.Gender==1?"男":"女")+"<br/>年龄: "+CommonFun.calculateAge(new Date(r.Birthday).Format("yyyy-MM-dd"))+"<br/>手机号: "+r.Mobile+"<br/></div>";$(q).parent().append(n);$(".tempPatientDetail").css("position","absolute");$(".tempPatientDetail").css("z-index","10");$(".tempPatientDetail").offset({top:m,left:s})};k.findAllItem=function(p,q,r){var m=null;for(var o=0;o<r.length;o++){var n=r[o][q];if(p==n){return JSON.parse(JSON.stringify(r[o]))}}return m};k.findItem=function(q,r,o,s){var m="";for(var p=0;p<s.length;p++){var n=s[p][r];if(q==n){return s[p][o]}}return m};k.isWithOperatePermission=function(m){var n=e.Auths[m];return h.isWithOperatePermission(MenuEnum.BookMG,n)};k.initialize=function(m){e.module=MenuEnum.BookMG};k.confirm=function(n,o,m){e.MsgBox.Confirm("温馨提示",n,o,m)};k.alert=function(m){e.MsgBox.Alert("消息",m)};return k}]);bookModule.controller("BookController",["$scope","BookService","CalendarService","$compile",function(i,c,a,d){var f=function(p,n){var l=new Date();if(p){l=new Date(p)}var m=l.getFullYear();var o=(l.getMonth()+1).toString();if(o.length==1){o="0"+o}var k=l.getDate().toString();if(k.length==1){k="0"+k}if(n==0){return m+"-"+o+"-"+k}var j=l.getHours().toString();if(j.length==1){j="0"+j}var q=l.getMinutes().toString();if(q.length==1){q="0"+q}return m+"-"+o+"-"+k+" "+j+":"+q+":00"};var e=function(k){var j=new Date();return new Date(k.toDate().getTime()+(j.getTimezoneOffset()*60000)).Format("yyyy-MM-dd hh:mm")};var h=function(o,j){var m=o._d.toJSON();var l=new Date();l=new Date(l.getTime()-(l.getTimezoneOffset()*60000)).toJSON();if(m<l){return}i.appointSources.splice(0,1);var n={id:80000,title:"预约",start:o,end:j};var k=[n];i.appointSources.push(k);i.newStartTime=e(o);i.newEndTime=e(j)};var b=function(){a.uiConfig.calendar.eventSources=[];a.uiConfig.calendar.header={left:"month,agendaWeek,agendaDay,listDay,listWeek,listMonth, today, prev,next",center:"",right:""};a.uiConfig.calendar.eventDragStop=function(l,k,m,j){return false};a.uiConfig.calendar.eventDrop=function(x,n,y,v,k,o,u,s){var r=a.getView("myCalendar3");i.currentViewName=r.name;if(x.source&&x.source.origArray.length>0){var l="";var q=x.id;for(var z=0;z<x.source.origArray.length;z++){if(q==x.source.origArray[z].id){l=x.source.origArray[z].source;break}}if(l){i.showCurrentAppoint(l);var m=new Date(l.Appoint.BeginTime);var p=new Date(l.Appoint.EndTime);var A=m.valueOf();var j=p.valueOf();var w=n._data.days*24*60*60*1000+n._data.hours*60*60*1000+n._data.minutes*60*1000;A=A+w;j=j+w;l.Appoint.BeginTime=f(new Date(A),1);l.Appoint.EndTime=f(new Date(j),1);var t=(new Date()).valueOf();if(t<=A){if(l.Appoint.Status==1||l.Appoint.Status==5){x.backgroundColor=c.getAppointColor(1);l.Appoint.Status=1}else{if(l.Appoint.Status==2){x.backgroundColor=c.getAppointColor(2);l.Appoint.Status=2}}}else{x.backgroundColor=c.getAppointColor(5);l.Appoint.Status=5}i.showCurrentAppoint(l);i.currentPatient.Appoint.BeginTime=f(new Date(A),1);i.currentPatient.Appoint.EndTime=f(new Date(j),1);i.saveInfo()}}};a.uiConfig.calendar.eventResize=function(k,l,q,p,r,s,t){var w=a.getView("myCalendar3");i.currentViewName=w.name;if(k.source&&k.source.origArray.length>0){var u="";var j=k.id;for(var m=0;m<k.source.origArray.length;m++){if(j==k.source.origArray[m].id){u=k.source.origArray[m].source;break}}if(u){i.showCurrentAppoint(u);var v=new Date(u.Appoint.EndTime);var n=v.valueOf();var o=l._data.days*24*60*60*1000+l._data.hours*60*60*1000+l._data.minutes*60*1000;n=n+o;u.Appoint.EndTime=f(new Date(n),1);i.currentPatient.Appoint.EndTime=f(new Date(n),1);i.showCurrentAppoint(u);i.saveInfo()}}};a.uiConfig.calendar.eventMouseover=function(m,k,j){if(m.source&&m.source.origArray.length>0){var n="";var o=m.id;for(var l=0;l<m.source.origArray.length;l++){if(o==m.source.origArray[l].id){n=m.source.origArray[l].source;break}}if(n&&(n.Appoint.Status<3||n.Appoint.Status>4)){$(k.currentTarget).prop("title","当前预约可以拖动和改变大小，修改预约的时间！");$(k.currentTarget).css("font-weight","normal");$(k.currentTarget).tooltip("show")}}};a.uiConfig.calendar.defaultDate=new Date().Format("yyyy-MM-dd")};i.initialize=function(){var j=a.getDateTime();i.currentPatient={};i.currentIndex=0;i.moveNum=0;i.doctorShowWidth=0;i.isAddNewAppoint=false;if(navigator.userAgent.indexOf("Firefox")>=0){if(screen.width>1680){i.doctorShowWidth=500}if(screen.height<=1680){i.doctorShowWidth=200}}else{if(screen.width>1366){i.doctorShowWidth=500}if(screen.width<=1366){i.doctorShowWidth=200}}i.appointSources=[{id:90000,title:"预约",start:j.startTime,end:j.endTime}];b();i.appointTypeList=[{Value:1,Text:"初诊"},{Value:2,Text:"复诊"}];i.genderList=[{Value:1,Text:"男"},{Value:2,Text:"女"}];i.relationList=[{Type:1,Name:"亲属"},{Type:2,Name:"朋友"},{Type:3,Name:"同事"},{Type:4,Name:"同学"},{Type:5,Name:"其他"}];c.initialize(i);c.GetAppointment(i);c.getAppointmentItemsList(i)};i.doctorListHandle=function(){$("#doctor-list").width=$(".doctor-list").length*80+"px"};i.edit=function(k){if(!c.isWithOperatePermission("OperateAuth_manageBookItem")){c.alert("对不起，您没有权限，请联系管理员！");return}var j=$(k.target).parent().parent();var l=j.next();j.hide();l.show()};i.callBack=function(j){a.setScope(i);i.uiConfig=a.uiConfig;if(!j){j="agendaWeek"}i.uiConfig.calendar.height=document.body.clientHeight-70;setTimeout(function(){a.changeView(j,"myCalendar3");a.refreshEventSources("myCalendar3");$("#hideDate").change(function(){var k=new Date($("#hideDate").val());if(i.isAddNewAppoint){i.bookDate=f(k,0);$("#workday").val(i.bookDate)}else{i.calendarDate=f(k,0);$("#workday1").val(i.calendarDate)}})},200)};i.$watchGroup(["newStartTime","newEndTime"],function(){if(i.newStartTime){i.bookDate=f(i.newStartTime,0)}});i.$watchGroup(["startTime","endTime"],function(){if(i.startTime){i.calendarDate=f(i.startTime,0)}});i.$watch("bookDate",function(){if(i.bookDate){a.gotoDate("new_calender",i.bookDate)}});i.$watch("calendarDate",function(){if(i.calendarDate){a.gotoDate("myCalendar3",i.calendarDate)}});i.$watch("window.innerWidth",function(){if(window.innerWidth<1680){i.doctorShowWidth=200}else{i.doctorShowWidth=500}});i.agendaDay=function(){a.changeView("agendaDay","myCalendar3")};i.agendaWeek=function(){a.changeView("agendaWeek","myCalendar3")};i.showAppoint=function(j,l,k){if(k){if($(".doctor-list").find("span.cus_doctor_selected")&&$(".doctor-list").find("span.cus_doctor_selected").length>0){$($(".doctor-list").find("span.cus_doctor_selected")).removeClass("cus_doctor_selected");$(k.target).addClass("cus_doctor_selected")}else{$($(".doctor-list").find("span.cus_doctor")[0]).addClass("cus_doctor_selected")}c.changeDoctor(i,l);a.refreshEventSources("myCalendar3");i.currentIndex=l}};i.leftShift=function(m,l){var n=$("#doctor_list").css("margin-left");var j=n.indexOf("p");var o=Math.abs(parseInt(n.substring(0,j)));var k="";if(l.target.nodeName=="SPAN"){k=$(l.target).parent()}else{k=l.target}if(!(o%100)&&$(k).prop("class").indexOf("cus_span_icon_disabled")<0){if(!n||n=="0px"){o=100;$("#doctor_list").animate({margin:"0 0 0 -100px"},1000)}else{o=o+100;$("#doctor_list").animate({margin:"0 0 0 -"+o},1000)}if($($("#doctor_list_area").find("button.ui-corner-right")[0]).prop("class").indexOf("cus_span_icon_active")<0){$($("#doctor_list_area").find("button.ui-corner-right")[0]).removeClass("cus_span_icon_disabled");$($("#doctor_list_area").find("button.ui-corner-right")[0]).addClass("cus_span_icon_active")}if((o+i.doctorShowWidth)>i.maxlength){$(k).removeClass("cus_span_icon_active");$(k).addClass("cus_span_icon_disabled")}}};i.rightShift=function(m,l){var n=$("#doctor_list").css("margin-left");var j=n.indexOf("p");var o=Math.abs(parseInt(n.substring(0,j)));var k="";if(l.target.nodeName=="SPAN"){k=$(l.target).parent()}else{k=l.target}if(!(o%100)&&$(k).prop("class").indexOf("cus_span_icon_disabled")<0){if(n&&n!="0px"){o=o-100;$("#doctor_list").animate({margin:"0 0 0 -"+o+"px"},1000)}if($($("#doctor_list_area").find("button.ui-corner-left")[0]).prop("class").indexOf("cus_span_icon_active")<0){$($("#doctor_list_area").find("button.ui-corner-left")[0]).removeClass("cus_span_icon_disabled");$($("#doctor_list_area").find("button.ui-corner-left")[0]).addClass("cus_span_icon_active")}if(o<=0){$(k).removeClass("cus_span_icon_active");$(k).addClass("cus_span_icon_disabled")}}};i.blurHide=function(j,k){$(document).click(function(m){var q=m,p=$(q.srcElement||q.target);if($(p).is("#"+k+",#"+k+" *")){var o=$($(p)[0]).parent()[0];if($(o).attr("class").indexOf("first")>-1||$(o).attr("class").indexOf("second")>-1){var l=$($(o)[0]).siblings();if(l!=undefined&&l.length>0){for(var n=0;n<l.length;n++){$(l[n]).children("ul").slideUp("slow")}}}}else{if(!$(p).is(".autoSelect[name="+j+"]")){$("#"+k).slideUp("slow")}}})};i.inactiveClick=function(j){var k=j.target;if($(k).siblings("ul").css("display")=="none"){$(k).parent("li").siblings("li").removeClass("inactives");$(k).addClass("inactives");$(k).siblings("ul").slideDown(100).children("li");if($(k).parents("li").siblings("li").children("ul").css("display")=="block"){$(k).parents("li").siblings("li").children("ul").parent("li").children("a").removeClass("inactives");$(k).parents("li").siblings("li").children("ul").slideUp(100)}}else{$(k).removeClass("inactives");$(k).siblings("ul").slideUp(100);$(k).siblings("ul").children("li").children("ul").parent("li").children("a").addClass("inactives");$(k).siblings("ul").children("li").children("ul").slideUp(100);$(k).siblings("ul").children("li").children("a").removeClass("inactives")}};i.selectDepartmentClick=function(k,j,l){$(".autoSelect[name='consultantDepartmentName']").val(k.Name);i.newAppoint.AppointItemName=k.Name;i.newAppoint.CategoryID=j.CategoryID;i.newAppoint.CategoryName=j.Name;i.newAppoint.SubCategoryName=l.Name;i.newAppoint.SubCategoryID=k.SubCategoryID;i.newAppoint.AppointItemID=k.AppointItemID};i.selectAppointItem=function(j){$(".autoSelect[name='appointmentItemsList2']").val(j.Name);i.currentPatient.Appoint.AppointItemName=j.Name;i.currentAppoint.Appoint.AppointItem=j.Name;i.currentPatient.Appoint.SubCategoryID=j.SubCategoryID;i.currentPatient.Appoint.AppointItemID=j.AppointItemID};i.focusShow=function(j,k){var n=j.target;var r=$("#new_appoint div.modal-body").height();var o=$("#book-mg").height();var l=n.offsetWidth;var q=n.offsetHeight;var m=n.offsetLeft;var p=n.offsetTop;if(k=="dataDepartment"){$("#"+k).css({left:m,bottom:(r-p+q+10),position:"absolute","max-height":300+"px",width:l,"z-index":9999,"overflow-y":"scroll"})}else{$("#"+k).css({left:m,bottom:(o-p-20),position:"absolute",width:l,"max-height":300+"px","z-index":9999,"overflow-y":"scroll"})}$("#"+k).slideDown("slow")};var g=function(l,m,n,k){var j="topLeft";if(k){j=k}if(n){$("#"+n).validationEngine("showPrompt",m,"",j,true);setTimeout(function(){$("#"+n).validationEngine("hideAll")},1000)}else{$(l).validationEngine("showPrompt",m,"",j,true);setTimeout(function(){$(l).validationEngine("hideAll")},1000)}};i.convertAppointStatus=function(j){switch(j){case 1:return"已预约";case 2:return"候诊中";case 3:return"治疗中";case 4:return"已完成";case 5:return"预约未到";default:return"暂无"}};i.showCurrentAppoint=function(j){$("#book-mg .div_edit").css("display","none");$("#book-mg .div_show").css("display","block");i.currentAppoint={Patient:{PatientName:j.Appoint.PatientName,GenderName:(j.Appoint.Gender==1?"男":"女"),Age:!j.Appoint.Birthday?"":CommonFun.calculateAge(new Date(j.Appoint.Birthday).Format("yyyy-MM-dd")),Mobile:j.Appoint.Mobile,PatientSource:j.Appoint.PatientSourceName,PatientLevel:j.Appoint.PatientLevelName,AppointTypeName:j.Appoint.AppointType==1?"初诊":"复诊"},Appoint:{AppointItem:j.Appoint.AppointItemName,AppointItemID:j.Appoint.AppointItemID,AppointDoctor:{UserID:j.Appoint.DoctorID,UserName:j.Appoint.DoctorName},AppointDoctorID:j.Appoint.DoctorID,AppointDate:j.Appoint.BeginTime,AppointStatus:j.Appoint.Status,AppointStatusName:i.convertAppointStatus(j.Appoint.Status)}};$("#book_status").css("background-color",c.getAppointColor(j.Appoint.Status));i.currentPatient.Appoint=j.Appoint;i.currentPatient.Level=j.Level;i.currentPatient.Source=j.Source};i.saveInfo=function(){if(!c.isWithOperatePermission("OperateAuth_manageBookItem")){c.alert("对不起，您没有权限，请联系管理员！");return}if(i.currentAppoint==null||i.currentAppoint.Appoint.AppointStatus==4){return}if(i.currentAppoint.Appoint.AppointDate>=i.currentPatient.Appoint.EndTime){g("","结束时间必须大于预约开始时间！","workdayBegin");return}if(!CommonFun.checkFormat($("#mobile").val(),DataTypeEnum.PhoneMobile)&&!CommonFun.checkFormat($("#mobile").val(),DataTypeEnum.Contract)){PlatformService.alert("电话号码无效，请重新输入");return}$("#loading_div").modal("show");i.currentPatient.Appoint.DoctorID=i.currentAppoint.Appoint.AppointDoctor.UserID;i.currentPatient.Appoint.DoctorName=i.currentAppoint.Appoint.AppointDoctor.UserName;i.currentPatient.Appoint.BeginTime=i.currentAppoint.Appoint.AppointDate;i.currentPatient.Appoint.Mobile=i.currentAppoint.Patient.Mobile;c.updateAppointments(i.currentPatient,i,false,false)};i.deleteAppoint=function(){if(!c.isWithOperatePermission("OperateAuth_manageBookItem")){c.alert("对不起，您没有权限，请联系管理员！");return}if(i.currentAppoint==null||(i.currentAppoint.Appoint.AppointStatus>2&&i.currentAppoint.Appoint.AppointStatus<5)){return}c.confirm("确定要取消【"+i.currentAppoint.Patient.PatientName+"】于【"+i.currentAppoint.Appoint.AppointDate+"】关于【"+i.currentAppoint.Appoint.AppointItem+"】的预约吗？",function(){var j=a.getView("myCalendar3");i.currentViewName=j.name;i.currentPatient.Appoint.State=1;c.updateAppointments(i.currentPatient,i,false,true)})};i.cancelAppoint=function(k,j){i.currentAppoint={Patient:{PatientName:k.Appoint.PatientName,GenderName:(k.Appoint.Gender==1?"男":"女"),Age:CommonFun.calculateAge(new Date(k.Appoint.Birthday).Format("yyyy-MM-dd")),Mobile:k.Appoint.Mobile,PatientSource:k.Appoint.PatientSourceName,PatientLevel:k.Appoint.PatientLevelName,AppointTypeName:k.Appoint.AppointType==1?"初诊":"复诊"},Appoint:{AppointItem:k.Appoint.AppointItemName,AppointItemID:k.Appoint.AppointItemID,AppointDoctor:{UserID:k.Appoint.DoctorID,UserName:k.Appoint.DoctorName},State:1,AppointDoctorID:k.Appoint.DoctorID,AppointDate:k.Appoint.BeginTime,AppointStatus:k.Appoint.Status,AppointStatusName:i.convertAppointStatus(k.Appoint.Status)}};j.stopPropagation();i.deleteAppoint()};i.refreshShowEdit=function(j){if(j==0){$("#book-mg div.div_show").show();$("#book-mg div.div_edit").hide()}};i.onResize=function(m,o,l,k,n,j){i.newStartTime=e(m.start);i.newEndTime=e(m.end)};i.addAppoint=function(){var j=a.getView("myCalendar3");i.currentViewName=j.name;if(!c.isWithOperatePermission("OperateAuth_manageBookItem")){c.alert("对不起，您没有权限，请联系管理员！");return}i.isAddNewAppoint=true;i.resetAppoint();$("#new_appoint").modal("show");i.newUiConfig={calendar:{height:350,header:{left:"",center:"",right:"today prev,next"},theme:true,axisFormat:"H(:mm):00",timeFormat:"H:mm",minTime:"8:00",maxTime:"23:00",allDaySlot:false,editable:true,selectable:true,dayNames:["星期天","星期一","星期二","星期三","星期四","星期五","星期六"],dayNamesShort:["星期天","星期一","星期二","星期三","星期四","星期五","星期六"],buttonText:{today:"今天"},eventClick:"",eventDrop:"",eventResize:i.onResize,eventRender:"",select:h}};if($("#new_appoint div.modal-dialog").height()<=600){i.newUiConfig.calendar.height=180}setTimeout(function(){a.changeView("agendaDay","new_calender");a.refreshEvent("new_calender");i.createCalendar=true;i.bookDate=new Date().Format("yyyy-MM-dd");if($("#workday").length<=0){var k=angular.element('<input id="workday" type="text" style="font-size: 12px;" placeholder="预约日期" class="form-control input-sm" name="workTime" ng-model="bookDate">');angular.element($($("#appoint_time_view .fc-header-toolbar").children("div.fc-left")[0])).append(d(k)(i));CommonFun.bindingDateControl("workday","","",false)}},500);$("#consultantDepartmentName").val("")};i.selectPatient=function(j){i.newAppoint.PatientID=j.PatientID;i.newAppoint.PatientName=j.Name;i.newAppoint.Birthday=j.Birthday;i.newAppoint.Age=CommonFun.calculateAge(new Date(j.Birthday).Format("yyyy-MM-dd"));i.newAppoint.Gender=j.Gender;i.newAppoint.Mobile=j.Mobile;i.newAppoint.Address=j.Address;i.newAppoint.OtherContact=j.OtherContact;i.newAppoint.PatientSourceID=j.PatientSourceID;i.newAppoint.PatientLevelID=j.PatientLevelID;i.disablePatientEdit=true};i.showSelectedPatientDetail=function(j,k){c.showCurrentPatient(j,k,i)};i.hideSelectedPatientDetail=function(j){$(".tempPatientDetail").remove()};i.closeAppoint=function(){i.isAddNewAppoint=false;$("#new_appoint").modal("hide")};i.saveAppoint=function(){if(!$.formValidator.pageIsValid("1")){return}if(i.newAppoint.DoctorID==null||i.newAppoint.DoctorID==""){g("","请选择就诊医生！","select_doctor");return}if(i.newAppoint.AppointItemName==null||i.newAppoint.AppointItemName==""){g("","请选择预约事项！","consultantDepartmentName");return}i.newAppoint.BeginTime=i.newStartTime;i.newAppoint.EndTime=i.newEndTime;if(i.newAppoint.BeginTime==null||i.newAppoint.BeginTime==""||i.newAppoint.BeginTime==undefined){g("","请选择预约时间！","workday","bottomLeft");return}var l=c.findAllItem(i.newAppoint.PatientSourceID,"PatientSourceID",i.patientSourceList);var k=c.findAllItem(i.newAppoint.PatientLevelID,"PatientLevelID",i.patientLevelList);i.newAppoint.DoctorName=c.findItem(i.newAppoint.DoctorID,"UserID","UserName",i.doctorList);var j={Appoint:i.newAppoint,Source:l,Level:k};c.saveAppoint(j,i)};i.resetAppoint=function(){i.consultantHospitalDepartmentName="";i.newAppoint={AppointType:1,Gender:1,TenantID:i.currentTenant.TenantID,Status:1,State:0,DoctorID:(i.doctorList!=null&&i.doctorList!=undefined)?i.doctorList[i.currentIndex].UserID:0};i.disablePatientEdit=false;i.canSelectPatient=true};i.initialize()}]);angular.bootstrap($("#main-content"),["BookModule"]);