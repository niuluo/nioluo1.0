var PatientMGData={};var GenderList=[{Type:0,Name:"请选择性别"},{Type:1,Name:"男"},{Type:2,Name:"女"}];var TreatTypeList=[{Type:0,Name:"请选择就诊类型"},{Type:1,Name:"初诊"},{Type:2,Name:"复诊"}];var PatientMG={validateRequired:function(b,a){if(!CommonFun.checkFormat(b,DataTypeEnum.Required)){return"此项为必填项"}else{return true}},validateMobile:function(b,a){if(!CommonFun.checkFormat(b,DataTypeEnum.Contract)&&!CommonFun.checkFormat(b,DataTypeEnum.PhoneMobile)){return"电话号码无效，请重新输入"}else{return true}},validateAge:function(b,a){if(!CommonFun.checkFormat(b,DataTypeEnum.Number)){return"年龄非法，请重新输入"}else{return true}},validateDate:function(b,a){if(!$("#new_patient input[name='birthday']")[0]){if(!CommonFun.checkFormat(b,DataTypeEnum.DateFormat)){return"日期格式不对，请重新输入！"}else{return true}}},validateGender:function(b,a){if(b=="number:0"||b=="0"){return"请选择性别"}else{return true}},validateTreatType:function(b,a){if(b=="number:0"||b=="0"){return"请选择就诊类型"}else{return true}},validateSource:function(b,a){if(b=="number:0"||b=="0"){return"请选择患者来源"}else{return true}},validatePatientType:function(b,a){if(b=="number:0"||b=="0"||b==""||b=="请选择患者类型"){return"请选择患者类型"}else{return true}},validateFee:function(b,a){if(!CommonFun.checkFormat(b,DataTypeEnum.FeeWithNegative)){return"数据不合法，请重新输入"}else{return true}},validateFeeWithoutNegative:function(b,a){if(!CommonFun.checkFormat(b,DataTypeEnum.Fee)){return"金额不合法，请重新输入"}else{return true}},drawTimeSpan:function(){var a=$(".cus_table").children("div.unit");var b=$("<div></div>");if(a!=undefined&&a.length>0){}},validateIdcard:function(b,a){if($("#new_patient input[name='idcard']").val()!=""){if(!CommonFun.checkFormat(b,DataTypeEnum.Identify)){return"格式不正确，请重新输入"}else{return true}}},init:function(){$("#loading_div").modal("show");MenuActive.setActive(MenuEnum.PatientMG);CommonFun.bindingDateControl("workday","",new Date(),false);CommonFun.bindingDateControl("pBirthday",new Date(),"",false);CommonFun.bindingDateControl("visit_time","",new Date(),false);$.formValidator.initConfig({validatorGroup:"1",mode:"AlertTip"});$($("#new_patient input[name='patientName']")[0]).formValidator({validatorGroup:"1"}).functionValidator({fun:PatientMG.validateRequired});$($("#new_patient select[name='pGender']")[0]).formValidator({validatorGroup:"1"}).functionValidator({fun:PatientMG.validateGender});$($("#new_patient input[name='mobile']")[0]).formValidator({validatorGroup:"1"}).functionValidator({fun:PatientMG.validateMobile});$($("#new_patient input[name='birthday']")[0]).formValidator({validatorGroup:"1"}).functionValidator({fun:PatientMG.validateDate});$($("#new_patient input[name='idcard']")[0]).formValidator({validatorGroup:"1"}).functionValidator({fun:PatientMG.validateIdcard});$.formValidator.initConfig({validatorGroup:"2",mode:"AlertTip"});$($("#patientDetail input[id='levelInDetail']")).formValidator({validatorGroup:"2"}).functionValidator({fun:PatientMG.validatePatientType});$($("#patientDetail select[name='pGender']")[0]).formValidator({validatorGroup:"2"}).functionValidator({fun:PatientMG.validateGender});$($("#patientDetail input[name='mobile']")[0]).formValidator({validatorGroup:"2"}).functionValidator({fun:PatientMG.validateMobile});$($("#patientDetail input[name='pSource']")[0]).formValidator({validatorGroup:"2"}).functionValidator({fun:PatientMG.validateSource});$($("#patientDetail input[name='patientName']")[0]).formValidator({validatorGroup:"2"}).functionValidator({fun:PatientMG.validateRequired});$.formValidator.initConfig({validatorGroup:"3",mode:"AlertTip"});$($("#new_reservation select[name='treatType']")[0]).formValidator({validatorGroup:"3"}).functionValidator({fun:PatientMG.validateTreatType});$($("#new_reservation select[name='sourceId']")[0]).formValidator({validatorGroup:"3"}).functionValidator({fun:PatientMG.validateSource});$($("#new_reservation select[name='doctorName']")[0]).formValidator({validatorGroup:"3"}).functionValidator({fun:PatientMG.validateRequired});$($("#new_reservation textarea[name='bookItem']")[0]).formValidator({validatorGroup:"3"}).functionValidator({fun:PatientMG.validateRequired});$($("#new_reservation textarea[name='workTime']")[0]).formValidator({validatorGroup:"3"}).functionValidator({fun:PatientMG.validateDate});$.formValidator.initConfig({validatorGroup:"4",mode:"AlertTip"});$($("#new_visit select[name='visitor']")[0]).formValidator({validatorGroup:"4"}).functionValidator({fun:PatientMG.validateRequired});$($("#new_visit input[name='visitItemsList']")[0]).formValidator({validatorGroup:"4"}).functionValidator({fun:PatientMG.validateRequired});$($("#new_visit input[name='visitTime']")[0]).formValidator({validatorGroup:"4"}).functionValidator({fun:PatientMG.validateRequired});$.formValidator.initConfig({validatorGroup:"5",mode:"AlertTip"});$.formValidator.initConfig({validatorGroup:"6",mode:"AlertTip"});$($("#account_manage input[name='rechargeAmount']")[0]).formValidator({validatorGroup:"6"}).functionValidator({fun:PatientMG.validateFeeWithoutNegative});$.formValidator.initConfig({validatorGroup:"7",mode:"AlertTip"});$($("#account_manage input[name='transferAmount']")[0]).formValidator({validatorGroup:"7"}).functionValidator({fun:PatientMG.validateFeeWithoutNegative});$.formValidator.initConfig({validatorGroup:"8",mode:"AlertTip"});$($("#account_manage input[name='refundAmount']")[0]).formValidator({validatorGroup:"8"}).functionValidator({fun:PatientMG.validateFeeWithoutNegative})}};PatientMG.init();var patientModule=angular.module("PatientModule",["HttpModule","CalendarModule","PermissionModule","PushMessageModule"]);patientModule.factory("PatientFactory",[function(){var b=function(f){var e={};if(f!=undefined&&f!=""&&f!=null){e={ID:f.ID,PatientLevelID:f.PatientLevelID,Name:f.Name,Color:f.Color,State:f.State,CreateTime:f.CreateTime,TenantID:f.TenantID}}return e};var d=function(f){var e={};if(f!=undefined&&f!=""&&f!=null){e={ID:f.ID,PatientSourceID:f.PatientSourceID,Name:f.Name,State:f.State,DateTime:f.DateTime,TenantID:f.TenantID}}return e};var a=function(l){var f={};var h={};var e={};if(l!=undefined&&l!=""&&l!=null){var n=PatientMGData.PatientLevelList;var m=PatientMGData.PatientSourceList;if(n!=""&&n!=null){for(var k=0;k<n.length;k++){if(n[k].PatientLevelID==l.PatientLevelID){h=b(n[k]);break}}}if(m!=""&&m!=null){for(var g=0;g<m.length;g++){if(m[g].PatientSourceID==l.PatientSourceID){e=d(m[g]);break}}}f={ID:l.ID,PatientID:l.PatientID,Name:l.Name,Gender:(l.Gender==""||l.Gender==null)?"0":GenderList[l.Gender],Birthday:!l.Birthday?"":new Date(l.Birthday).Format("yyyy-MM-dd"),Age:(l.Birthday!=null&&l.Birthday!="")?CommonFun.calculateAge(new Date(l.Birthday).Format("yyyy-MM-dd")):"",Mobile:l.Mobile,Address:l.Address,PatientLevel:h,PatientSource:e,TreatNo:l.TreatNo,State:l.State,MedicalRecordNo:l.MedicalRecordNo,Remark:l.Remark,TenantID:l.TenantID,CreateTime:l.CreateTime,ExpireTime:l.ExpireTime,MainID:l.MainID,Relation:l.Relation,InsuranceName:l.InsuranceName,InsuranceNo:l.InsuranceNo,InsuranceType:l.InsuranceType,SocialSecurityNo:l.SocialSecurityNo,Amount:l.Amount,CardNo:l.CardNo,OpenID:l.OpenID,IdentityCardNo:l.IdentityCardNo}}return f};var c=function(k){var f={};var e={};if(k!=undefined&&k!=null&&k!=""){var m=PatientMGData.PatientSourceList;var n=PatientMGData.Doctors;var g={};if(m!=""&&m!=null){for(var h=0;h<m.length;h++){if(m[h].PatientSourceID==k.PatientSourceID){e=d(m[h]);break}}}if(n!=undefined&&n!=null&&n!=""){for(var l=0;l<n.length;l++){if(n[l].UserID==k.DoctorID){g=n[l];break}}}f={ID:k.ID,AppointID:k.AppointID,AppointNo:k.AppointNo,PatientID:k.PatientID,Name:k.Name,Birthday:k.Birthday,Gender:(k.Gender==undefined||k.Gender=="")?GenderList[0]:GenderList[k.Gender],Mobile:k.Mobile,Address:k.Address,Remark:k.Remark,AppointTime:k.AppointTime,AppointDetail:k.AppointDetail,Status:k.Status,Doctor:g,AppointType:(k.AppointType==undefined||k.AppointType=="")?TreatTypeList[0]:TreatTypeList[k.AppointType],State:k.State,CreateTime:k.CreateTime,PatientSource:e,TenantID:k.TenantID,MainID:k.MainID,Relation:k.Relation,OpenID:k.OpenID}}return f};return{MappingPatient:function(e){return a(e)},SearchRequest:{Type:0,PatientLevelID:0,Condition:""},DealResponsePatients:function(f){var e={PatientList:[],PatientInfoList:[]};var j=new Array();if(f!=undefined&&f!=null&&f!=""){for(var g=0;g<f.length;g++){var h=a(f[g]);e.PatientList.push(h);e.PatientInfoList.push({PatientID:h.PatientID,PatientName:h.Name,Gender:h.Gender,Mobile:h.Mobile});j.push({label:h.Name+"--"+h.Mobile,value:h.PatientID})}$("#language").autocomplete({delay:0,source:j,focus:function(i,k){$("#language").val(k.item.label);return false},select:function(i,k){$("#language").val(k.item.label);$("#language-id").val(k.item.value);return false}})}return e},DealPatientRequest:function(h){var e={};var k=CommonFun.getDataFromSession("CurrentUser");var j=PatientMGData.PatientLevelList;var f=PatientMGData.PatientSourceList;if(h!=undefined&&h!=null&&h!=""){e.Patient={ID:h.ID,PatientID:h.PatientID,Name:h.Name,Gender:h.Gender.Type,MedicalRecordNo:h.MedicalRecordNo,Birthday:!h.Birthday?"":new Date(h.Birthday).Format("yyyy-MM-dd"),Mobile:h.Mobile,Address:h.Address,PatientLevelID:h.PatientLevel.PatientLevelID,PatientSourceID:h.PatientSource.PatientSourceID,TreatNo:h.TreatNo,State:h.State,Remark:h.Remark,TenantID:k!=null?k.Body.Tenant.TenantID:"",CreateTime:h.CreateTime,MainID:h.MainID,Relation:h.Relation,SocialSecurityNo:h.SocialSecurityNo,InsuranceName:h.InsuranceName,InsuranceNo:h.InsuranceNo,InsuranceType:h.InsuranceType,Amount:h.Amount,CardNo:h.CardNo,OpenID:h.OpenID,IdentityCardNo:h.IdentityCardNo}}if(j!=undefined&&j!=null&&j.length>0){if(h.PatientLevel.PatientLevelID==""){e.PatientLevel=h.PatientLevel;if(h.PatientLevel.Name=="请选择患者类型"){e.PatientLevel=""}}for(var g=0;g<j.length;g++){if(h.PatientLevel.PatientLevelID==j[g].PatientLevelID){e.PatientLevel=j[g];e.PatientLevel.Color=h.PatientLevel.Color;break}}}if(f!=undefined&&f!=null&&f.length>0){if(h.PatientSource.PatientSourceID==""){e.PatientSource=h.PatientSource;if(h.PatientSource.Name=="请选择患者来源"){e.PatientSource=""}}for(var g=0;g<f.length;g++){if(h.PatientSource.PatientSourceID==f[g].PatientSourceID){e.PatientSource=f[g];break}}}return e},ConvertPatient:function(m){var f={};var n=PatientMGData.PatientLevelList;var g=PatientMGData.PatientSourceList;var k={};var e={};if(!m.PatientLevel){m.PatientLevel={PatientLevelID:m.PatientLevelID}}if(!m.PatientSource){m.PatientSource={PatientSourceID:m.PatientSourceID}}if(!m.Gender.Type){m.Gender={Type:m.Gender,Name:m.Gender==1?"男":"女"}}if(m!=undefined&&m!=null&&m!=""){if(m.PatientLevel!=undefined&&m.PatientLevel!=""&&m.PatientLevel!=null){for(var l=0;l<n.length;l++){if(n[l].PatientLevelID==m.PatientLevel.PatientLevelID){k=b(n[l]);break}}}if(m.PatientSource!=undefined&&m.PatientSource!=null&&m.PatientSource!=""){for(var h=0;h<g.length;h++){if(g[h].PatientSourceID==m.PatientSource.PatientSourceID){e=d(g[h]);break}}}f={ID:m.ID,PatientID:m.PatientID,Name:m.Name,Gender:m.Gender,Birthday:!m.Birthday?"":new Date(m.Birthday).Format("yyyy-MM-dd"),Age:!m.Birthday?"":CommonFun.calculateAge(new Date(m.Birthday).Format("yyyy-MM-dd")),Mobile:m.Mobile,Address:m.Address,PatientLevel:k,PatientSource:e,MedicalRecordNo:m.MedicalRecordNo,TreatNo:m.TreatNo,State:m.State,Remark:m.Remark,TenantID:m.TenantID,CreateTime:m.CreateTime,ExpireTime:m.ExpireTime,MainID:m.MainID,Relation:m.Relation,SocialSecurityNo:m.SocialSecurityNo,InsuranceName:m.InsuranceName,InsuranceNo:m.InsuranceNo,InsuranceType:m.InsuranceType,Amount:m.Amount,CardNo:m.CardNo,OpenID:m.OpenID,IdentityCardNo:m.IdentityCardNo}}return f},MappingAppointment:function(e){return c(e)},DealAppointmentRequest:function(f,g){var e={};if(f!=undefined&&f!=null&&f!=""){e={ID:f.ID,AppointID:f.AppointID,AppointNo:f.AppointNo,AppointItemID:f.AppointItemID,AppointItemName:f.AppointItemName,AppointDetail:"",PatientID:f.PatientID,PatientName:f.Name,BeginTime:f.BeginTime,EndTime:f.EndTime,Birthday:f.Birthday,Gender:f.Gender.Type,Mobile:f.Mobile,Address:f.Address,Remark:f.Remark,AppointTime:f.AppointTime,Status:f.Status,DoctorID:f.DoctorID,DoctorName:f.DoctorName,AppointType:f.AppointType.Type,State:f.State,CreateTime:f.CreateTime,PatientLevelID:g.PatientLevel.PatientLevelID,PatientLevelName:g.PatientLevel.Name,PatientSourceID:f.PatientSource.PatientSourceID,PatientSourceName:f.PatientSource.Name,TenantID:f.TenantID,MainID:f.MainID,Relation:f.Relation,OpenID:f.OpenID,SubCategoryID:f.SubCategoryID,SubCategoryName:f.SubCategoryName,CategoryID:f.CategoryID,CategoryName:f.CategoryName}}return e},DealCostItems:function(f,h){var e;if(f&&!$.isArray(f)){e=f.item;if(!e.Price){e.Price={ID:0,CostItemID:e.Item.CostItemID,SubCategoryID:e.Item.SubCategoryID,Unit:"",Price:0,State:0,TenantID:e.Item.TenantID,CreateTime:""}}e.Category={CategoryID:f.categoryInfo.CategoryID,CategoryName:f.categoryInfo.CategoryName};e.SubCategory={SubCategoryID:f.categoryInfo.SubCategoryID,SubCategoryName:f.categoryInfo.SubCategoryName}}if(f&&f.length>0){e=[];for(var g=0;g<f.length;g++){if(!f[g].Price){f[g].Price={ID:0,CostItemID:f[g].Item.CostItemID,SubCategoryID:f[g].Item.SubCategoryID,Unit:"",Price:0,State:0,TenantID:f[g].Item.TenantID,CreateTime:""}}f[g].Category={CategoryID:h.CategoryID,CategoryName:h.CategoryName};f[g].SubCategory={SubCategoryID:h.SubCategoryID,SubCategoryName:h.SubCategoryName};e.push(f[g])}}return e}}}]);patientModule.service("PatientService",["PatientFactory","HttpService","ResourceFactory","$location","PermissionFactory",function(f,d,b,g,a){var c={};var e="";c.ConvertPatient=function(h){return f.ConvertPatient(h)};c.getVisitTreatList=function(l){var m=PatientMGData.AppointList;var j=l.currentPatient;var h=[];if(m!=undefined&&m!=""&&m!=null){for(var k=0;k<m.length;k++){if(m[k].Status==4){h.push(m[k])}}}return h};c.GetListForVisit=function(i,h){d.getListForVisitRequest(i,b.operateCode.get,function(j){if(j.Header.StatusCode==0){h.completeTreatList=j.Body}else{h.completeTreatList=null}},function(j){console.log(j)})};c.findAllItem=function(l,m,n){var h=null;if(n==[]){return}else{for(var k=0;k<n.length;k++){var j=n[k][m];if(l==j){return JSON.parse(JSON.stringify(n[k]))}}}return h};c.getPatientTypeList=function(m,k){var h=[];if(k==1){h=[{Type:0,PatientLevelID:0,Name:"全部"}]}else{h=[{Type:0,PatientLevelID:0,Name:"请选择患者类型"}]}if(m!=undefined&&m!=null&&m!=""){for(var j=0;j<m.length;j++){var l={Type:j+1,PatientLevelID:m[j].PatientLevelID,Name:m[j].Name};h.push(l)}}return h};c.getPatientSourceList=function(j){var h=[{Type:0,PatientSourceID:0,Name:"请选择患者来源"}];if(j!=undefined&&j!=null&&j!=""){for(var k=0;k<j.length;k++){var l={Type:k+1,PatientSourceID:j[k].PatientSourceID,Name:j[k].Name};h.push(l)}}return h};c.getMappingPatientList=function(h){return f.DealResponsePatients(h)};c.getSearchRequest=function(){return f.SearchRequest};c.getMappingPatient=function(h){return f.MappingPatient(h)};c.searchPatients=function(i){var k;var j=i.searchRequest;if(j!=""&&j!=null&&j!=undefined){var h=0;if(j.Condition!=undefined&&j.Condition!=""){if(CommonFun.checkFormat(j.Condition,DataTypeEnum.Number)){h=2}else{h=1}}var l=CommonFun.getDataFromSession("CurrentUser");k={TenantId:l!=null?l.Body.Tenant.TenantID:"",SearchType:h,PatientLevel:j.PatientLevelID,Condition:j.Condition==undefined?"":j.Condition}}else{k={TenantId:l!=null?l.Body.Tenant.TenantID:"",SearchType:0,PatientLevel:"",Condition:""}}try{d.patientRequest(k,b.operateCode.get,function(n){if(n.Header.StatusCode==0){PatientMGData.PatientList=n.Body.PatientList;PatientMGData.PatientLevelList=n.Body.PatientLevelList;PatientMGData.PatientSourceList=n.Body.PatientSourceList;i.patientList=f.DealResponsePatients(PatientMGData.PatientList).PatientList;i.currentPatient=i.patientList[0];if(n.Body==null||n.Body.PatientList.length<=0){$("#patient_operate").hide();c.alert("没有符合条件的数据！")}else{$("#patient_operate").show()}}else{c.alert(GetErrormsg(n.Header.StatusCode))}},function(n){c.alert("系统繁忙，请稍候重试！");console.log(n)})}catch(m){console.log(m)}};c.savePatient=function(h){var i=f.DealPatientRequest(h.newPatient);i.Patient.State=0;try{d.patientRequest(i,b.operateCode.insert,function(k){h.isAbled=true;if(k.Header.StatusCode==0){$("#new_patient").modal("hide");c.alert("新增患者成功！");c.searchPatients(h)}else{if(k.Header.StatusCode==18){var l=k.Body.Gender==2?"女":"男";c.confirm("对不起，该手机号已经注册，手机号主人姓名：【"+k.Body.Name+"】，性别：【"+l+"】，是否关联该手机号？",function(){h.isRelation=true;h.newPatient.Relation=1;h.newPatient.MainID=k.Body.PatientID;h.$apply()})}else{c.alert(GetErrormsg(k.Header.StatusCode))}}},function(k){c.alert("系统繁忙，请稍后重试！");console.log(k)})}catch(j){console.log(j)}};c.updatePatient=function(h){h.editPatient.MedicalRecordNo=h.currentPatient.MedicalRecordNo;h.editPatient.OpenID=h.currentPatient.OpenID;var i=f.DealPatientRequest(h.editPatient);i.isForceUpdate=h.isForceUpdate;try{d.patientRequest(i,b.operateCode.update,function(k){if(k.Header.StatusCode==0){for(var l=0;l<h.patientList.length;l++){if(h.patientList[l].ID==i.Patient.ID){h.patientList[l]=f.ConvertPatient(h.editPatient);h.currentPatient=f.ConvertPatient(h.editPatient);h.patientList[l].PatientLevel=h.editPatient.PatientLevel;h.currentPatient.PatientLevel=h.editPatient.PatientLevel;$("#patientDetail .div_edit").hide();$("#patientDetail .div_show").show();break}}c.alert("更新信息成功！");c.searchPatients(h)}else{if(k.Header.StatusCode==18){var m=k.Body.Gender==2?"女":"男";c.confirm("对不起，该手机号已经被注册，手机号主人姓名：【"+k.Body.Name+"】，性别：【"+m+"】，是否关联该手机号？",function(){h.isRelation=true;h.newPatient.Relation=1;h.newPatient.MainID=k.Body.PatientID;h.$apply()});return}if(k.Header.StatusCode==34){c.confirm("当前手机号有关联的信息，如果选择更新，所有关联的信息的手机号会一起更新，确定更新吗？",function(){h.isForceUpdate=true;c.updatePatient(h)});return}if(k.Header.StatusCode==35){c.alert("对不起，您的手机号目前被其他患者关联，您无法关联其他手机号！");return}c.alert(GetErrormsg(k.Header.StatusCode))}},function(k){c.alert("系统繁忙，请稍候重试！");console.log(k)})}catch(j){console.log(j)}};c.exportPatient=function(j){if(j.Condition!=""&&j.Condition!=undefined){if(CommonFun.checkFormat(j.Condition,DataTypeEnum.PhoneMobile)){j.Type=2}else{j.Type=1}}var h=CommonFun.getDataFromSession("CurrentUser");var i=WebServer.getUrl("PatientExport");i=i+"?TenantID="+h.Body.Tenant.TenantID+"&SearchType="+j.Type+"&Condition="+j.Condition+"&PatientLevel="+j.PatientLevelID+"&Token="+h.Header.Token+"&Module="+b.module;window.location.href=i};c.getAppointmentItemsList=function(h){var i={TenantID:h.currentUser.Body.Tenant.TenantID};d.appointmentItemsRequest(i,b.operateCode.get,function(j){if(j.Header.StatusCode==0){h.appointmentItems=j.Body}else{h.appointmentItems=null}},function(j){console.log(j)})};c.visitItemsList=function(h){var i={TenantID:h.currentUser.Body.Tenant.TenantID};d.visitItemsRequest(i,b.operateCode.get,function(j){if(j.Header.StatusCode==0){h.visitItemsList=j.Body}else{h.visitItemsList=null}},function(j){console.log(j)})};c.deletePatient=function(h){h.currentPatient.State=1;var i=f.DealPatientRequest(h.currentPatient);i.isForceUpdate=h.isForceUpdate;try{d.patientRequest(i,b.operateCode.remove,function(k){if(k.Header.StatusCode==0){c.searchPatients(h);c.alert("删除成功！")}else{if(k.Header.StatusCode==34){c.confirm("当前患者还有关联的信息，可以把关联信息一起删除，确定继续删除吗？",function(){h.isForceUpdate=true;c.deletePatient(h)})}if(k.Header.StatusCode==48){c.alert("该患者还有账单存在！不能删除");return}}},function(k){console.log(k)})}catch(j){console.log(j)}};c.saveReservation=function(n){var j=n.startTime.getHours();var l=n.startTime.getMinutes();var o=n.startTime.getSeconds();var q=n.endTime.getHours();var r=n.endTime.getMinutes();var t=n.endTime.getSeconds();var h=n.appointment;h.DoctorID=n.selectedDoctor.UserID;h.DoctorName=n.selectedDoctor.UserName;if(j<10){j="0"+n.startTime.getHours()}if(l<10){l="0"+n.startTime.getMinutes()}if(o<10){o="0"+n.startTime.getSeconds()}if(q<10){q="0"+n.endTime.getHours()}if(r<10){r="0"+n.endTime.getMinutes()}if(t<10){t="0"+n.endTime.getSeconds()}h.BeginTime=n.appointment.AppointTime+" "+j+":"+l+":"+o;h.EndTime=n.appointment.AppointTime+" "+q+":"+r+":"+t;var s=c.findAllItem(h.PatientSource.PatientSourceID,"PatientSourceID",PatientMGData.PatientSourceList);var i=c.findAllItem(h.PatientSource.PatientLevelID,"PatientLevelID",PatientMGData.PatientLevelList);var k=f.DealAppointmentRequest(h,n.currentPatient);var m={Appoint:k,Source:s,Level:i};try{d.appointmentRequest(m,b.operateCode.insert,function(u){if(u.Header.StatusCode==0){$("#new_reservation").modal("hide");c.alert("预约成功！")}else{c.alert(GetErrormsg(u.Header.StatusCode))}},function(u){console.log(u)})}catch(p){console.log(p)}};c.saveVisit=function(i,h){try{d.visitRequest(i,b.operateCode.insert,function(k){if(k.Header.StatusCode==0){$("#new_visit").modal("hide");c.alert("回访创建成功！");h.currentPatient.VisitHistory.push(h.currentPatient.visit)}else{c.alert(GetErrormsg(k.Header.StatusCode))}},function(k){c.alert("系统繁忙，请稍后再试！");console.log(k)})}catch(j){console.log(j)}};c.getMainCatalog=function(h){var i={TenantID:h.currentUser.Body.Tenant.TenantID};d.mainCatalogRequest(i,b.operateCode.get,function(j){if(j.Header.StatusCode==0){h.MainCategoryList=j.Body}else{h.MainCategoryList=null}},function(j){console.log(j)})};c.saveFee=function(i,h){try{d.createBillRequest(i,b.operateCode.update,function(k){if(k.Header.StatusCode==0){c.alert("账单生成成功，请到收费处缴费！");$("#charge").modal("hide")}else{c.alert(GetErrormsg(k.Header.StatusCode))}},function(k){console.log(k)})}catch(j){console.log(j)}};c.addDetailItem=function(h){e.currentCostItems.push(h);e.$apply()};c.getCatalogItems=function(h,j){var i={TenantID:h.currentPatient.TenantID};if(j!=undefined&&j==""){i.CategoryID=j}try{d.subCatalogRequest(i,b.operateCode.get,function(l){if(l.Header.StatusCode==0){$("#loading_div").modal("hide");if(j==undefined){h.CatalogItems=l.Body;h.createTree(h.CatalogItems)}h.SubItems=h.CatalogItems[0].SubCategories}else{$("#loading_div").modal("hide");c.alert(GetErrormsg(l.Header.StatusCode))}},function(l){c.alert("系统繁忙，请稍后重试！");console.log(l)})}catch(k){console.log(k)}};c.getDetailCatalog=function(h,k,j){if(k==undefined){var i={TenantID:h.currentAppoint.TenantID,SubCategoryID:h.currentAppoint.SubCategoryID}}else{var i={TenantID:h.currentPatient.TenantID,CategoryID:k.CategoryID,SubCategoryID:k.SubCategoryID}}d.costItemsRequest(i,b.operateCode.get,function(m){if(m.Header.StatusCode==0){if(k){var p=$.parseJSON(j.JsonData);var l={CategoryID:p.CategoryID,CategoryName:p.CategoryName,SubCategoryID:p.SubCategoryID,SubCategoryName:p.Name};j.removeChildNodes();for(var o=0;o<m.Body.length;o++){var n={item:m.Body[o],categoryInfo:l};j.createChildNode(m.Body[o].Item.Name,false,"icon-folder-close-alt",null,"",JSON.stringify(n),3,function(r){var q=$.parseJSON(r);c.addDetailItem(f.DealCostItems(q))})}j.expandNode()}else{h.currentCostItems=f.DealCostItems(m.Body,h.currentAppoint)}}else{h.currentCostItems=null;c.alert(GetErrormsg(m.Header.StatusCode))}},function(l){console.log(l)})};c.accountRecharge=function(i,h){try{d.accountRechargeRequest(i,b.operateCode.insert,function(k){h.isCompleted=true;if(k.Header.StatusCode==0){h.account=k.Body;h.currentPatient.Amount=h.account.Amount;h.orginCurrentPatient.Amount=h.account.Amount;c.alert("充值成功！");var l={TenantID:i.TenantID,PatientID:i.PatientID};h.resetAccountUpdate();c.getAccountPipeline(l,h)}else{c.alert(GetErrormsg(k.Header.StatusCode))}},function(k){c.alert("系统繁忙，请稍候重试！");console.log(k)})}catch(j){console.log(j)}};c.accountTransfer=function(i,h){try{d.accountTransferRequest(i,b.operateCode.insert,function(k){h.isCompleted=true;if(k.Header.StatusCode==0){h.account=k.Body;h.currentPatient.Amount=h.account.Amount;h.orginCurrentPatient.Amount=h.account.Amount;c.alert("转账成功！");var l={TenantID:i.TenantID,PatientID:i.PatientID};h.resetAccountUpdate();c.getAccountPipeline(l,h)}else{c.alert(GetErrormsg(k.Header.StatusCode))}},function(k){c.alert("系统繁忙，请稍候重试！");console.log(k)})}catch(j){console.log(j)}};c.accountRefund=function(i,h){try{d.accountRefundRequest(i,b.operateCode.insert,function(k){h.isCompleted=true;if(k.Header.StatusCode==0){h.account=k.Body;h.currentPatient.Amount=h.account.Amount;h.orginCurrentPatient.Amount=h.account.Amount;c.alert("退款成功！");var l={TenantID:i.TenantID,PatientID:i.PatientID};h.resetAccountUpdate();c.getAccountPipeline(l,h)}else{c.alert(GetErrormsg(k.Header.StatusCode))}},function(k){c.alert("系统繁忙，请稍候重试！");console.log(k)})}catch(j){console.log(j)}};c.getAccountPipeline=function(i,h){try{d.accountRequest(i,b.operateCode.get,function(k){if(k.Header.StatusCode==0){h.accountPipeLineList=k.Body.Histories;h.account=k.Body.Account;if(!h.account){h.account={ID:0,PatientID:h.currentPatient.PatientID,TenantID:h.currentPatient.TenantID,Amount:0,State:0,CreateTime:""}}}else{c.alert(GetErrormsg(k.Header.StatusCode))}},function(k){c.alert("系统繁忙，请稍后再试！");console.log(k)})}catch(j){console.log(j)}};c.getQRCodeInfos=function(i,h){try{d.createSceneQRCodeRequest(i,b.operateCode.get,function(k){if(k.Header.StatusCode==0){h.currentPatient.QRCodes=FileURL+"QRCode/"+k.Body.QRCode}else{c.alert(GetErrormsg(k.Header.StatusCode))}},function(k){console.log(k)})}catch(j){console.log(j)}};c.initialize=function(i){b.module=MenuEnum.PatientMG;e=i;CommonFun.bindingDateControl("visitTime","",new Date(),true,"hour");var h=CommonFun.getDataFromSession("CurrentUser");CommonFun.saveDataToSession("module",MenuEnum.PatientMG);var j={TenantId:h.Body.Tenant.TenantID};try{d.patientRequest(j,b.operateCode.get,function(l){$(".body_hide").css("opacity","1");$("#loading_div").modal("hide");if(l.Header.StatusCode==0){PatientMGData=l.Body;i.patientTypeList=c.getPatientTypeList(PatientMGData.PatientLevelList,1);i.PatientLevelList=PatientMGData.PatientLevelList;i.patientSourceList=c.getPatientSourceList(PatientMGData.PatientSourceList);var m=c.getMappingPatientList(PatientMGData.PatientList);i.patientList=m.PatientList;i.patientInfoList=m.PatientInfoList;i.currentPatient=c.ConvertPatient(i.patientList[0])}else{c.alert(GetErrormsg(l.Header.StatusCode))}},function(l){console.log(l)})}catch(k){console.log(k)}};c.isWithOperatePermission=function(h){var i=b.Auths[h];return a.isWithOperatePermission(MenuEnum.PatientMG,i)};c.confirm=function(i,j,h){b.MsgBox.Confirm("温馨提示",i,j,h)};c.alert=function(h){b.MsgBox.Alert("消息",h)};return c}]);patientModule.controller("PatientController",["PatientService","$scope","$location","CalendarService","$timeout","PushMessageService","$compile",function(g,k,f,a,b,i,d){var c=false;var e=function(r,p){var n="";if(p==0&&!r){n=new Date()}else{if(!r){return""}else{n=r}}var o=n.getFullYear();var q=(n.getMonth()+1).toString();if(q.length==1){q="0"+q}var m=n.getDate().toString();if(m.length==1){m="0"+m}if(p==0){return o+"-"+q+"-"+m}var l=n.getHours().toString();if(l.length==1){l="0"+l}var s=n.getMinutes().toString();if(s.length==1){s="0"+s}return o+"-"+q+"-"+m+" "+l+":"+s+":00"};k.initialize=function(){k.genderList=GenderList;k.searchRequest=g.getSearchRequest();k.InsuranceTypeList=[{Type:"0",Name:"其他"},{Type:"1",Name:"人寿保险"},{Type:"2",Name:"健康保险"},{Type:"3",Name:"人身意外伤害保险"}];k.ChargeTypeList=[{Type:"1",Name:"现金"},{Type:"2",Name:"银行卡"},{Type:"3",Name:"微信"},{Type:"4",Name:"支付宝"},{Type:"5",Name:"社保卡"},{Type:"6",Name:"会员卡"},{Type:"8",Name:"其他"}];g.initialize(k);k.appointment={};a.setScope(k);k.uiConfig=a.uiConfig;k.eventSources=a.eventSources;k.currentUser=CommonFun.getDataFromSession("CurrentUser");k.ChargePattern=true;k.isAbled=true;k.isCompleted=true;k.relationList=[{Type:1,Name:"亲属"},{Type:2,Name:"朋友"},{Type:3,Name:"同事"},{Type:4,Name:"同学"},{Type:5,Name:"其他"}];k.options={name:"",textLimit:10,offsetX:3,offsetYs:3,beforeShow:$.noop,afterShow:$.noop};k.mouseClickMenu=[[{text:"新增预约",func:k.addNewReservation}],[{text:"新增回访",func:k.addNewVisit}],[{text:"创建账单",func:k.addCharge}],[{text:"查看详情",func:k.showDetail}]]};k.convertInsuranceType=function(l){switch(l){case"0":return"其他";case"1":return"人寿保险";case"2":return"健康保险";case"3":return"人身意外伤害保险";default:return""}};k.searchPatients=function(){g.searchPatients(k)};k.addNewPatient=function(){if(!g.isWithOperatePermission("OperateAuth_addPatient")){g.alert("对不起，您没有权限，请联系管理员！");return}k.isRelation=false;k.resetPatient();$("#new_patient").modal("show")};k.savePatient=function(){if(k.isAbled){k.isAbled=false;if(!$.formValidator.pageIsValid("1")){k.isAbled=true;return}g.savePatient(k)}else{return false}};k.resetPatient=function(){k.selectPatientTypeList=g.getPatientTypeList(PatientMGData.PatientLevelList,2);k.newPatient={ID:0,PatientID:0,Name:"",Gender:GenderList[0],Birthday:"",Mobile:"",Address:"",PatientLevel:k.selectPatientTypeList[0],PatientSource:k.patientSourceList[0],MedicalRecordNo:"",Label:"",State:"",Remark:"",TenantID:"",CreateTime:"",InsuranceNo:"",InsuranceType:"0",SocialSecurityNo:"",InsuranceName:"",CardNo:"",Amount:0,OpenID:"",IdentityCardNo:""}};k.updatePatient=function(){if(!c&&!$.formValidator.pageIsValid("2")){return}var n=false;for(var m=0;m<k.PatientLevelList.length;m++){var l=k.PatientLevelList[m];if(k.editPatient.PatientLevel.Name==l.Name){k.editPatient.PatientLevel.PatientLevelID=l.PatientLevelID;k.editPatient.PatientLevel.ID=l.ID;n=true}}if(!n){k.editPatient.PatientLevel.CreateTime="";k.editPatient.PatientLevel.ID="0";k.editPatient.PatientLevel.PatientLevelID="";k.editPatient.PatientLevel.State=0;k.editPatient.PatientLevel.TenantID=k.currentUser.Body.Tenant.TenantID}g.updatePatient(k);c=false};k.OpenClick=function(){k.currentPatient.OpenID="";k.editPatient=g.ConvertPatient(k.currentPatient);g.updatePatient(k)};k.editPatientInfo=function(){if(!g.isWithOperatePermission("PatientMG_editPatient")){g.alert("对不起，您没有权限，请联系管理员！");return}k.isForceUpdate=false;k.selectPatientTeList=g.getPatientTypeList(PatientMGData.PatientLevelList,2);k.editPatient=g.ConvertPatient(k.currentPatient);$(".div_edit").show();$(".div_show").hide()};k.changePatientLevel=function(){k.searchPatientLevels=[];if(k.editPatient.PatientLevel.Name==""){return}for(var m=0;m<k.PatientLevelList.length;m++){var l=k.PatientLevelList[m];if(l.Name.indexOf(k.editPatient.PatientLevel.Name.toUpperCase())>-1){k.searchPatientLevels.push(l)}}};k.searchTemplateClick=function(l){k.currentPatient.PatientLevel.Name=l.Name;k.currentPatient.PatientLevel.PatientLevelID=l.PatientLevelID;k.currentPatient.PatientLevel.ID=l.ID;k.currentPatient.PatientLevel.Color=l.Color;k.editPatient.PatientLevel.Name=l.Name;k.editPatient.PatientLevel.PatientLevelID=l.PatientLevelID;k.editPatient.PatientLevel.ID=l.ID;k.searchPatientLevels=[]};k.showBaseDetail=function(n,m,l){if($($("#patient_list tbody").children("tr.selected"))){$($("#patient_list tbody").children("tr.selected")).children("td.selected").removeClass("selected");$($("#patient_list tbody").children("tr.selected")).removeClass("selected")}if(l.button==0||l.button==2){if(l.button==2){$(l.target).smartMenu(k.mouseClickMenu,k.options)}$($("#patient_list tbody").children("tr")[m]).addClass("selected");$($("#patient_list tbody").children("tr")[m]).children("td").addClass("selected");c=false;$("#patientDetail .div_edit").hide();$("#patientDetail .div_show").show();k.currentIndex=m;k.orginCurrentPatient=n;k.currentPatient=g.ConvertPatient(n)}};k.blurHide=function(l,m){$(document).click(function(o){var s=o,r=$(s.srcElement||s.target);if($(r).is("#"+m+",#"+m+" *")){var q=$($(r)[0]).parent()[0];if($(q).attr("class").indexOf("first")>-1||$(q).attr("class").indexOf("second")>-1){var n=$($(q)[0]).siblings();if(n!=undefined&&n.length>0){for(var p=0;p<n.length;p++){$(n[p]).children("ul").slideUp("slow")}}}}else{if(!$(r).is(".autoSelect[name="+l+"]")){$("#"+m).slideUp("slow")}}})};k.inactiveClick=function(l){var m=l.target;if($(m).siblings("ul").css("display")=="none"){$(m).parent("li").siblings("li").removeClass("inactives");$(m).addClass("inactives");$(m).siblings("ul").slideDown(100).children("li");if($(m).parents("li").siblings("li").children("ul").css("display")=="block"){$(m).parents("li").siblings("li").children("ul").parent("li").children("a").removeClass("inactives");$(m).parents("li").siblings("li").children("ul").slideUp(100)}}else{$(m).removeClass("inactives");$(m).siblings("ul").slideUp(100);$(m).siblings("ul").children("li").children("ul").parent("li").children("a").addClass("inactives");$(m).siblings("ul").children("li").children("ul").slideUp(100);$(m).siblings("ul").children("li").children("a").removeClass("inactives")}};k.selectDepartmentClick=function(m,l,n){$(".autoSelect[name='consultantDepartmentName']").val(m.Name);k.appointment.AppointItemName=m.Name;k.appointment.CategoryID=l.CategoryID;k.appointment.CategoryName=l.Name;k.appointment.SubCategoryName=n.Name;k.appointment.SubCategoryID=m.SubCategoryID;k.appointment.AppointItemID=m.AppointItemID};k.selectCategoryClick=function(l){$(".autoSelect[name='visitItemsList']").val(l.Name);k.addVisit.VisitItemName=l.Name;k.addVisit.SubCategoryID=l.SubCategoryID;k.addVisit.VisitItemID=l.VisitItemID};k.focusShow=function(m,s){var q=m.target;var r=$("#new_reservation div.modal-body").height();var n=q.offsetWidth;var l=q.offsetHeight;var p=q.offsetLeft;var o=q.offsetTop;if(s=="visitItems"){$("#"+s).css({left:p,top:(o+l),position:"absolute",width:n,"z-index":9999,"max-height":300+"px","overflow-y":"scroll"})}else{$("#"+s).css({left:p,bottom:(r-o+l+10),position:"absolute",width:n,"z-index":9999,"max-height":300+"px","overflow-y":"scroll"})}$("#"+s).slideDown("slow")};k.deletePatient=function(){if(!g.isWithOperatePermission("OperateAuth_deletePatient")){g.alert("对不起，您没有权限，请联系管理员！");return}g.confirm("确认要删除患者："+k.currentPatient.Name+"吗？",function(){g.deletePatient(k)})};k.saveReservation=function(){if(!$.formValidator.pageIsValid("3")){return}if(!k.startTime||!k.endTime){j("","请选择预约时间！","workday","bottomLeft");return}if(k.appointment.AppointItemName==null||k.appointment.AppointItemName==""){j("","请选择预约事项！","consultantDepartmentName","bottomLeft");return}g.saveReservation(k)};k.resetCalendar=function(){a.renewEvents();k.appointment.AppointTime=e(new Date(),0)};k.resetReservation=function(){k.appointment={ID:0,AppointID:0,AppointNo:0,PatientID:k.currentPatient.PatientID,Name:k.currentPatient.Name,Birthday:k.currentPatient.Birthday,Gender:k.currentPatient.Gender,Mobile:k.currentPatient.Mobile,Address:k.currentPatient.Address,Remark:k.currentPatient.Remark,AppointTime:"",BeginTime:"",EndTime:"",AppointDetail:"",Status:1,DoctorID:"",AppointType:TreatTypeList[0],State:0,CreateTime:"",PatientSource:k.currentPatient.PatientSource,TenantID:k.currentPatient.TenantID};$(".ng-valid-parse[name='treatType']").val("number:0");$(".ng-pristine[name='doctorName']").val("");$(".autoSelect[name='consultantDepartmentName']").val("");k.resetCalendar()};k.addNewReservation=function(){if(!g.isWithOperatePermission("OperateAuth_manageBookItem")){g.alert("对不起，您没有权限，请联系管理员！");return}k.treatTypeList=TreatTypeList;k.doctors=PatientMGData.DoctorList;k.resetReservation();g.getAppointmentItemsList(k);if($("#new_reservation div.modal-dialog").height()<=600){a.uiConfig.calendar.height=180}setTimeout(function(){a.changeView("agendaDay","myCalendar2");a.refreshEventSources("myCalendar2");$("#hideDate").change(function(){var m=new Date($("#hideDate").val());k.appointment.AppointTime=e(m,0);$("#workday").val(k.appointment.AppointTime)});if($("#workday").length<=0){var l=angular.element('<input id="workday" type="text" style="font-size: 12px;" placeholder="预约日期" class="form-control input-sm" name="workTime" ng-model="appointment.AppointTime">');angular.element($($("#appoint_time_view .fc-header-toolbar").children("div.fc-left")[0])).append(d(l)(k));CommonFun.bindingDateControl("workday","","",false)}},500);k.$watchGroup(["startTime","endTime"],function(){k.appointment.AppointTime=e(k.startTime,0)});k.$watch("appointment.AppointTime",function(){if(k.appointment.AppointTime==""){a.gotoDate("myCalendar2",new Date())}else{a.gotoDate("myCalendar2",k.appointment.AppointTime)}});$("#new_reservation").modal("show")};k.resetVisit=function(l){if(l==1){$($("#new_visit div.div_edit")[0]).css("display","inline-block");$($("#new_visit div.div_show")[0]).hide()}if(l==0){$($("#new_visit div.div_edit")[0]).hide();$($("#new_visit div.div_show")[0]).css("display","inline-block")}};k.$watch("selectedAppoint",function(){var l=k.selectedAppoint;if(k.addVisit==null){return}if(l||l.Appoint){k.addVisit.TreatDoctorID="";k.addVisit.TreatDoctorName="";k.addVisit.TreatTime=""}else{k.addVisit.TreatDoctorID=l.Appoint.DoctorID;k.addVisit.TreatDoctorName=l.Appoint.DoctorName;k.addVisit.TreatTime=l.Appoint.BeginTime}});k.addNewVisit=function(){if(!g.isWithOperatePermission("OperateAuth_manageVisitItem")){g.alert("对不起，您没有权限，请联系管理员！");return}var l={PatientID:k.currentPatient.PatientID,TenantID:k.currentPatient.TenantID};k.doctors=PatientMGData.UserList;k.resetVisit(0);g.GetListForVisit(l,k);g.visitItemsList(k);var m=JSON.parse(JSON.stringify(k.currentPatient));k.addVisit={PatientID:m.PatientID,PatientName:m.Name,Gender:m.Gender.Type,Mobile:m.Mobile,TreatDoctorID:m.DoctorID,TreatDoctorName:m.DoctorName,TreatTime:m.BeginTime,State:0,Status:1,VisitContent:"",VisitResult:"",VisitTime:"",Remark:"",TenantID:m.TenantID};$("#new_visit").modal("show")};k.saveVisit=function(){if(!$.formValidator.pageIsValid("4")){return}k.addVisit.VisitorID=k.selectedVisitor.UserID;k.addVisit.VisitorName=k.selectedVisitor.UserName;g.saveVisit(k.addVisit,k)};k.addCharge=function(){if(!g.isWithOperatePermission("PatientMG_addBill")){g.alert("对不起，您没有权限，请联系管理员！");return}k.resetCharge();$("#loading_div").modal("show");var l={PatientID:k.currentPatient.PatientID,TenantID:k.currentPatient.TenantID};g.getCatalogItems(k);g.GetListForVisit(l,k);g.getMainCatalog(k);k.addMoney={};$("#charge").modal("show")};k.checkChargePattern=function(){k.originalFee=0;k.planTotalFee=0;k.discount=100;k.totalFeeWithoutDiscount=0;if($("#costPattern").html()=="项目明细"){$("#costPattern").html("快速填写");$("#detailedCharge").show();$("#fastCharge").hide();k.ChargePattern=false;k.detailItemsSum();if(k.completeTreat){k.currentAppoint=k.completeTreat.Appoint;g.getDetailCatalog(k)}}else{if(k.completeTreat){k.currentAppoint=k.completeTreat.Appoint}$("#costPattern").html("项目明细");$("#fastCharge").show();$("#detailedCharge").hide();k.MainCategorySum();k.ChargePattern=true}k.calculateDiscountFee()};k.calculateDiscountFee=function(){if(k.discount<0||k.discount>100){j("","折扣率无效，请重新输入！","discount");k.planTotalFee=k.totalFeeWithoutDiscount}else{k.planTotalFee=(k.discount/100*parseFloat(k.totalFeeWithoutDiscount)*1).toFixed(2)}};k.$watch("completeTreat",function(){var l=k.completeTreat;$("#appoint_name").validationEngine("hideAll");if(k.completeTreatList==null){return}if(l==null){k.currentCostItems=[];k.addMoney.DoctorName="";k.addMoney.BeginTime="";k.addMoney.EndTime=""}else{if($("#costPattern").html()=="快速填写"){k.currentAppoint=k.completeTreat.Appoint;g.getDetailCatalog(k)}k.addMoney.AppointID=l.Appoint.AppointID;k.addMoney.AppointItemName=l.Appoint.AppointItemName;k.addMoney.DoctorName=l.Appoint.DoctorName;k.addMoney.BeginTime=l.Appoint.BeginTime;k.addMoney.EndTime=l.Appoint.EndTime}});k.deleteChargeItem=function(m){for(var l=0;l<k.currentCostItems.length;l++){if(m.Item.ID==k.currentCostItems[l].Item.ID){k.currentCostItems.splice(l,1);k.detailItemsSum(m);return}}};k.detailItemsSum=function(n){var l=0;var m=0;if(n){n.planSum=(n.amount*n.Price.Price).toFixed(2)}if(k.currentCostItems&&k.currentCostItems.length>0){angular.forEach(k.currentCostItems,function(o){if(o.amount&&CommonFun.checkFormat(o.amount,DataTypeEnum.Number)){l=parseFloat(l)+parseFloat(o.amount*o.Price.Price);m=m+parseFloat(o.planSum)}})}if(k.discount){if(k.discount<0||k.discount>100){j("","折扣率无效，请重新输入！","discount");k.discount=100;k.planTotalFee=m.toFixed(2)}else{m=(k.discount/100*m*1).toFixed(2);k.planTotalFee=m}}else{k.planTotalFee=m}k.originalFee=l.toFixed(2);k.totalFeeWithoutDiscount=l.toFixed(2)};k.calculatePlanSum=function(){var l=0;if(k.currentCostItems&&k.currentCostItems.length>0){angular.forEach(k.currentCostItems,function(m){if(m.amount&&CommonFun.checkFormat(m.amount,DataTypeEnum.Number)){l=l+parseFloat(m.planSum)}});k.totalFeeWithoutDiscount=l.toFixed(2);k.calculateDiscountFee()}};k.MainCategorySum=function(){var l=0;if(k.MainCategoryList!=undefined&&k.MainCategoryList!=null&&k.MainCategoryList.length>0){angular.forEach(k.MainCategoryList,function(m){if(m.Price!=undefined&&m.Price!=""&&CommonFun.checkFormat(m.Price,DataTypeEnum.Fee)){l=parseFloat(l)+parseFloat(m.Price)}});k.originalFee=l.toFixed(2);k.totalFeeWithoutDiscount=l.toFixed(2)}if(k.discount){if(k.discount<0||k.discount>100){j("","折扣率无效，请重新输入！","discount");k.discount=100;k.planTotalFee=l.toFixed(2)}else{l=(k.discount/100*l*1).toFixed(2);k.planTotalFee=l}}else{k.planTotalFee=l.toFixed(2)}};k.calculateSum=function(l){if(l.amount){if(!CommonFun.checkFormat(l.amount,DataTypeEnum.Number)){return 0}l.sum=parseFloat(l.Price.Price*l.amount).toFixed(2);if(l.amount==0){l.sum=0}}else{l.sum=0}return Math.abs(l.sum)};k.createTree=function(n){var p={context1:{elements:[{text:"展开",icon:"icon-star-empty",action:function(r){r.expandNode()}},{text:"收缩",icon:"icon-star-empty",action:function(r){r.collapseNode()}}]}};if(n){k.tree=createTree("ItemTree","white",p);for(var q=0;q<n.length;q++){var m=k.tree.createNode(n[q].Category.Name,false,"icon-folder-close-alt",null,null,"context1",JSON.stringify(n[q]),1);for(var o=0;o<n[q].SubCategories.length;o++){n[q].SubCategories[o].CategoryName=n[q].Category.Name;var l=m.createChildNode(n[q].SubCategories[o].Name,false,"icon-folder-close-alt",null,"context2",JSON.stringify(n[q].SubCategories[o]),2,function(t,s){var r=$.parseJSON(t);g.getDetailCatalog(k,r,s)})}}}k.tree.drawTree()};var h=function(l){if(l.toString().length==1){return"0"+l}return l};k.appointTimeText=function(n,m){var o=new Date(n);var l=new Date(m);return h(o.getHours())+":"+h(o.getMinutes())+"-"+h(l.getHours())+":"+h(l.getMinutes())};k.StateTexts=function(l){if(!l){return"未绑定"}else{return"已绑定"}};k.saveCharge=function(){var m=[];var n=false;if(!k.completeTreat){j($("#appoint_name"),"请选择就诊事项!");return}var o={Bill:{PatientID:k.currentPatient.PatientID,AppointID:k.completeTreat.Appoint.AppointID,TenantID:k.currentPatient.TenantID,BillNo:null,CreateTime:null,OriginalPrice:k.originalFee,Discount:k.discount,DueCharge:k.planTotalFee,RealCharge:0,Arrears:0,Refund:0,DoctorID:k.completeTreat.Appoint.DoctorID,DoctorName:k.completeTreat.Appoint.DoctorName,BillStatus:1,State:0,Description:k.Description},Costs:[]};if(!k.planTotalFee){g.alert("账单金额不能为0！");return}if(k.ChargePattern){for(var l=0;l<k.MainCategoryList.length;l++){if(k.MainCategoryList[l].Price!=""&&k.MainCategoryList[l].Price!=undefined){$("#p_"+[l]).formValidator({validatorGroup:"5"}).functionValidator({fun:PatientMG.validateFee})}k.MainCategoryList[l].ChargeItem={Price:k.MainCategoryList[l].Price,Remark:k.MainCategoryList[l].Remark,CategoryID:k.MainCategoryList[l].CategoryID,CategoryName:k.MainCategoryList[l].Name,TenantID:k.currentUser.Body.Tenant.TenantID,State:0,PatientID:k.currentPatient.PatientID,AppointID:k.addMoney.AppointID,AppointItemName:k.addMoney.AppointItemName,DiscountPrice:k.MainCategoryList[l].Price};if(k.MainCategoryList[l].ChargeItem.Price){m.push(k.MainCategoryList[l].ChargeItem)}}if($.formValidator.pageIsValid("5")){o.Costs=m;g.saveFee(o,k)}}else{for(var l=0;l<k.currentCostItems.length;l++){k.currentCostItems[l].ChargeItem={Price:k.currentCostItems[l].sum,Remark:k.currentCostItems[l].Remark,CategoryID:k.currentCostItems[l].Category.CategoryID,CategoryName:k.currentCostItems[l].Category.CategoryName,SubCategoryID:k.currentCostItems[l].SubCategory.SubCategoryID,SubCategoryName:k.currentCostItems[l].SubCategory.SubCategoryName,CostItem:k.currentCostItems[l].Item.Name,CostItemID:k.currentCostItems[l].Item.CostItemID,TenantID:k.currentPatient.TenantID,State:0,PatientID:k.currentPatient.PatientID,AppointID:k.completeTreat.Appoint.AppointID,DiscountPrice:k.currentCostItems[l].planSum};if(k.currentCostItems[l].ChargeItem.Price){m.push(k.currentCostItems[l].ChargeItem);if(k.currentCostItems[l].isValidate!=undefined&&!k.currentCostItems[l].isValidate){n=false;break}if(k.currentCostItems[l].isValidate){n=true}}}if(m.length<=0){g.alert("请至少选择一项！");return}if(n){o.Costs=m;g.saveFee(o,k)}}};var j=function(n,o,p,m){var l="topLeft";if(m){l=m}if(p){$("#"+p).validationEngine("showPrompt",o,"",l,true);setTimeout(function(){$("#"+p).validationEngine("hideAll")},1000)}else{$(n).validationEngine("showPrompt",o,"",l,true);setTimeout(function(){$(n).validationEngine("hideAll")},1000)}};k.checkPriceFormat=function(m,n,l){m.isValidate=false;if(l==1){if(m.Price!=undefined&&m.Price!=""&&!CommonFun.checkFormat(m.Price,DataTypeEnum.Fee)){j(n.target,"请输入有效金额,小数点后保留2位!");m.isValidate=false}else{$(n.target).validationEngine("hideAll");m.Price=((m.Price==""||m.Price==undefined)?"":parseFloat(m.Price).toFixed(2));m.isValidate=true}}if(l==2){if(m.amount!=undefined&&m.amount!=""&&!CommonFun.checkFormat(m.amount,DataTypeEnum.Number)){j(n.target,"请输入正整数!");m.isValidate=false}else{$(n.target).validationEngine("hideAll");m.isValidate=true}}};k.resetCharge=function(){k.originalFee=0;k.currentCostItems=[];k.totalFeeWithoutDiscount=0;k.selectedAppoint={};k.isRefund=false;k.discount=100;k.Description="";k.planTotalFee=0;k.currentPatient.ChargeItem={item1:"",item2:"",item3:"",item4:"",item5:""}};k.exportToExcel=function(){if(!g.isWithOperatePermission("OperateAuth_exportPatient")){g.alert("对不起，您没有权限，请联系管理员！");return}g.exportPatient(k.searchRequest)};k.showDetail=function(){if(k.currentPatient.Name){CommonFun.saveDataToSession("CurrentPatient",k.currentPatient);CommonFun.saveDataToSession("module",MenuEnum.PatientMG);window.location.href="../WebPages/DCPatientDetail.html"}};k.checkIsOwner=function(l){if(l.MainID){return"（副）"}else{return"（主）"}};k.printChargeOrder=function(){k.chargeList=[];k.chargeTotal=0;if(k.ChargePattern){for(var l=0;l<k.MainCategoryList.length;l++){if(k.MainCategoryList[l].Price){k.chargeList.push({Price:k.MainCategoryList[l].Price,Remark:k.MainCategoryList[l].Remark,CostItem:k.MainCategoryList[l].Name,Information:k.MainCategoryList[l].Price.indexOf("-")>-1?"退费：￥"+Math.abs(parseFloat(k.MainCategoryList[l].Price)):"收费：￥"+k.MainCategoryList[l].Price});k.chargeTotal=k.chargeTotal+parseFloat(k.MainCategoryList[l].Price)}}}else{for(var l=0;l<k.currentCostItems.length;l++){if(k.currentCostItems[l].sum){k.chargeList.push({Price:k.currentCostItems[l].sum,Remark:k.currentCostItems[l].Remark,CostItem:k.currentCostItems[l].Item.Name,Information:k.currentCostItems[l].sum.indexOf("-")>-1?"退费：￥"+Math.abs(parseFloat(k.currentCostItems[l].sum)):"收费：￥"+k.currentCostItems[l].sum});k.chargeTotal=k.chargeTotal+parseFloat(k.currentCostItems[l].sum)}}}b(function(){$.print("#charge_order")},1000)};k.resetAccountUpdate=function(){k.recharge.RechargeAmount=0;k.recharge.RechargeType="8";k.recharge.Remark="";k.transfer.TransferAmount=0;k.transfer.Remark="";k.transfer.SelectedPatientID="";k.refund.RefundAmount=0;k.refund.Remark=""};k.amountRecharge=function(){if(k.currentPatient){$("#account_manage").modal("show");$("#language").val("");k.activePanel("recharge");k.recharge={RechargeAmount:0,RechargeType:"8",Remark:""};k.transfer={TransferAmount:0,Remark:"",SelectedPatientID:""};k.refund={RefundAmount:0,Remark:""};var l={TenantID:k.currentPatient.TenantID,PatientID:k.currentPatient.PatientID};k.accountPipeLineList=[];g.getAccountPipeline(l,k)}else{g.alert("请先选择患者！")}};k.activePanel=function(l){$("#recharge").removeClass("cus_active");$("#transfer").removeClass("cus_active");$("#refund").removeClass("cus_active");$("#recharge_tab").removeClass("account_tab_active");$("#transfer_tab").removeClass("account_tab_active");$("#refund_tab").removeClass("account_tab_active");switch(l){case"recharge":$("#recharge").removeClass("cus_disabled");$("#recharge").addClass("cus_active");$("#recharge_tab").addClass("account_tab_active");if($("#transfer").prop("class").indexOf("cus_disabled")<0){$("#transfer").addClass("cus_disabled")}if($("#refund").prop("class").indexOf("cus_disabled")<0){$("#refund").addClass("cus_disabled")}break;case"transfer":$("#transfer").removeClass("cus_disabled");$("#transfer").addClass("cus_active");$("#transfer_tab").addClass("account_tab_active");if($("#recharge").prop("class").indexOf("cus_disabled")<0){$("#recharge").addClass("cus_disabled")}if($("#refund").prop("class").indexOf("cus_disabled")<0){$("#refund").addClass("cus_disabled")}break;case"refund":$("#refund").removeClass("cus_disabled");$("#refund").addClass("cus_active");$("#refund_tab").addClass("account_tab_active");if($("#recharge").prop("class").indexOf("cus_disabled")<0){$("#recharge").addClass("cus_disabled")}if($("#transfer").prop("class").indexOf("cus_disabled")<0){$("#transfer").addClass("cus_disabled")}break;default:break}};k.updateAccount=function(m){if(k.isCompleted){var l="";var o="";if(k.currentUser.Body.UserType==1){l=k.currentUser.Body.Tenant.TenantID;o="院长"}else{l=k.currentUser.Body.User.UserID;o=k.currentUser.Body.User.UserName}var n={PatientID:k.currentPatient.PatientID,TenantID:k.currentPatient.TenantID,Amount:0,AccountOperateType:m,PayeeID:l,PayeeName:o,PaymentCategory:"",Description:"",ToPatientID:""};switch(m){case 1:if(!g.isWithOperatePermission("PatientMG_accountRecharge")){g.alert("对不起，您没有权限，请联系管理员！");return}if($.formValidator.pageIsValid("6")){if(k.recharge.RechargeAmount<=0){j("","对不起，充值金额不能为0！","recharge_amount");return}k.currentAccountType=m;k.isCompleted=false;n.Amount=k.recharge.RechargeAmount;n.PaymentCategory=k.recharge.RechargeType;n.Description=k.recharge.Remark;g.accountRecharge(n,k)}break;case 2:if(!g.isWithOperatePermission("PatientMG_accountRefund")){g.alert("对不起，您没有权限，请联系管理员！");return}if($.formValidator.pageIsValid("8")){if(k.refund.RefundAmount<=0){j("","对不起，退款金额不能为0！","refund_amount");return}if(k.account.Amount<k.refund.RefundAmount){j("","对不起，账户余额不足，无法退款！","refund_amount");return}k.currentAccountType=m;k.isCompleted=false;n.Amount=k.refund.RefundAmount;n.Description=k.refund.Remark;n.PaymentCategory=0;g.accountRefund(n,k)}break;case 3:if(!g.isWithOperatePermission("PatientMG_accountTransfer")){g.alert("对不起，您没有权限，请联系管理员！");return}if($.formValidator.pageIsValid("7")){if(k.transfer.RefundAmount<=0){j("","对不起，转账金额不能为0！","transfer_amount");return}if(k.account.Amount<k.transfer.TransferAmount){j("","对不起，账户余额不足，无法转账！","transfer_amount");return}k.currentAccountType=m;k.isCompleted=false;n.Amount=k.transfer.TransferAmount;n.Description=k.transfer.Remark;n.ToPatientID=$("#language-id").val();n.PaymentCategory=0;g.accountTransfer(n,k)}break;default:break}}else{switch(k.currentAccountType){case 1:alert("充值正在进行，请耐心等待！");break;case 2:alert("转账正在进行，请耐心等待！");break;case 3:alert("退款正在进行，请耐心等待！");break;default:break}return false}};k.convertOperator=function(l){switch(l){case 1:return"充值";case 2:return"退款";case 3:return"转出";case 4:return"转入";default:return"无"}};k.convertChargeType=function(l){if(l){switch(l){case 1:return"现金";case 2:return"银行卡";case 3:return"微信";case 4:return"支付宝";case 5:return"社保卡";case 6:return"会员卡";case 8:return"其他";case 9:return"账单退款";default:return"无"}}else{return"无"}};k.getQRCodes=function(){if(!k.currentPatient){g.alert("请先选择患者！");return}var l={PatientID:k.currentPatient.PatientID};g.getQRCodeInfos(l,k)};k.initialize()}]);angular.bootstrap($("#main-content"),["PatientModule"]);