var SMSMG = {
    init: function () {
        $("#loading_div").modal("show");
        ManagementMenuActive.setActive(ManagementMenuEnum.SmsPlatform)
    }
};
SMSMG.init();
var smsModule = angular.module("SMSModule", ["ManagementHttpModule"]);
smsModule.factory("SMSFactory", [function () {
    return {}
}]);
smsModule.service("SMSService", ["ResourceFactory", "SMSFactory", "ManagementHttpService", function (b, d, c) {
    var a = {};
    a.initialize = function () {
        b.bindingDateTimeControl("start_date");
        b.bindingDateTimeControl("end_state");
        $.formValidator.initConfig({validatorGroup: "1", mode: "AlertTip"});
        $($("input[id='start_date']")).formValidator({validatorGroup: "1"}).functionValidator({fun: b.validateDate});
        $($("input[id='end_state']")).formValidator({validatorGroup: "1"}).functionValidator({fun: b.validateDate});
        $.formValidator.initConfig({validatorGroup: "2", mode: "AlertTip"});
        $("#jump_page").formValidator({validatorGroup: "2"}).functionValidator({fun: b.validateNumber})
    };
    a.calculatePages = function (k, g, l) {
        var e = [];
        if (!l) {
            if (g > k) {
                return e
            } else {
                var j = Math.floor(k / 5);
                var h = 0;
                if (g >= (1 + j * 5)) {
                    for (var f = g; f <= k; f++) {
                        e.push(f)
                    }
                } else {
                    if (g + 4 >= k) {
                        for (var f = g; f <= k; f++) {
                            e.push(f)
                        }
                    } else {
                        for (var f = g; f <= g + 4; f++) {
                            e.push(f)
                        }
                    }
                }
            }
        } else {
            for (var f = g - 5; f < g; f++) {
                e.push(f)
            }
        }
        return e
    };
    a.getSMSList = function (f) {
        f.btnIsDisabled = true;
        var g = f.searchRequest;
        try {
            c.smsRequest(g, b.operateCode.get, function (e) {
                $("#loading_div").modal("hide");
                $(".data_element").fadeIn();
                f.btnIsDisabled = false;
                if (e.Header.StatusCode == 0) {
                    f.smsList = e.Body.SMSList;
                    f.totalCount = e.Body.Count;
                    if (e.Body.Count <= g.Count) {
                        f.totalPages = 1
                    } else {
                        f.totalPages = Math.ceil(e.Body.Count / g.Count)
                    }
                    if (f.isSwitchPages) {
                        f.currentFivePages = a.calculatePages(f.totalPages, 1, false)
                    }
                } else {
                    alert("获取短信列表失败，请稍后再试！");
                    console.log(e)
                }
            }, function (e) {
                alert("系统繁忙，请稍后再试！");
                console.log(e)
            })
        } catch (h) {
            console.log(h)
        }
    };
    return a
}]);
smsModule.controller("SMSController", ["$scope", "SMSService", "ResourceFactory", function (b, c, a) {
    b.initialize = function () {
        b.smsList = [];
        b.totalCount = 0;
        b.totalPages = 0;
        b.currentFivePages = [];
        b.currentPageNum = 1;
        b.isSwitchPages = true;
        b.btnIsDisabled = false;
        if (screen.height <= 768) {
            b.pageSizeList = [{Type: 1, Value: 5}, {Type: 2, Value: 10}]
        } else {
            b.pageSizeList = [{Type: 1, Value: 10}, {Type: 2, Value: 15}]
        }
        b.searchRequest = {Condition: "", StatusCode: 0, BeginTime: "", EndTime: "", Count: 10, Index: 1};
        b.smsStates = [{Type: 0, Name: "全部"}, {Type: 1, Name: "发送成功"}, {Type: 2, Name: "发送失败"}];
        c.initialize();
        c.getSMSList(b)
    };
    b.getSMSState = function (d) {
        b.smsState = 0;
        switch (d) {
            case"200":
                b.smsState = 1;
                return "发送成功";
            case"1":
                b.smsState = 1;
                return "发送成功";
            case"2":
                b.smsState = 0;
                return "发送失败";
            default:
                b.smsState = 0;
                return "发送失败"
        }
    };
    b.getMessageType = function (d) {
        b.smsType = 0;
        switch (d) {
            case 2:
                b.smsType = 2;
                return "验证码";
            case 1:
                b.smsType = 1;
                return "医嘱";
            default:
                b.smsType = 0;
                return "未知"
        }
    };
    b.changePageSize = function () {
        b.isSwitchPages = true;
        c.getSMSList(b)
    };
    b.prevPages = function () {
        if (b.currentFivePages[0] <= 5) {
            alert("对不起，已经在最前了！")
        } else {
            b.currentFivePages = c.calculatePages(b.totalPages, b.currentFivePages[0], true)
        }
    };
    b.nextPages = function () {
        var e = Math.floor(b.totalPages / 5);
        var d = e * 5 + 1;
        if (b.currentFivePages[0] >= d) {
            alert("对不起，已经在最后了！")
        } else {
            b.currentFivePages = c.calculatePages(b.totalPages, b.currentFivePages[4] + 1, false)
        }
    };
    b.isDisabled = function () {
        var e = Math.floor(b.totalPages / 5);
        var d = e * b.searchRequest.Count + 1;
        if (b.currentPageNum >= d) {
            return true
        } else {
            return false
        }
    };
    b.switchToCurrentPage = function (d) {
        $("#loading_div").modal("show");
        b.currentPageNum = d;
        b.isSwitchPages = false;
        b.searchRequest.Index = d;
        c.getSMSList(b)
    };
    b.jumpToPage = function () {
        if (!$.formValidator.pageIsValid("2")) {
            return
        }
        if (b.currentPageNum > b.totalPages) {
            alert("对不起，没有当前的页数！")
        } else {
            b.searchRequest.Index = b.currentPageNum;
            c.getSMSList(b)
        }
    };
    b.searchSMS = function () {
        if (b.searchRequest.BeginTime != "" || b.searchRequest.EndTime != "") {
            if (!a.checkFormat(b.searchRequest.BeginTime, DataTypeEnum.DateFormat)) {
                $("#start_date").tooltip("show");
                return
            }
            if (!a.checkFormat(b.searchRequest.EndTime, DataTypeEnum.DateFormat)) {
                $("#end_state").tooltip("show");
                return
            }
        }
        if (b.searchRequest.BeginTime > b.searchRequest.EndTime) {
            $("#start_date").tooltip("show");
            $("#end_state").tooltip("show");
            return
        }
        c.getSMSList(b)
    };
    b.initialize()
}]);
angular.bootstrap($("#main-content"), ["SMSModule"]);